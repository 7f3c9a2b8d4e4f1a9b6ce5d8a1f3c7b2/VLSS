# Audit Report

## Title
Protocol Fee Loss on Accrued Rewards During V1 to V2 Migration

## Summary
During the V1 to V2 migration, the protocol permanently loses its 10% reward fees on all rewards accrued after the `update_rewards()` function was deprecated. The migration flow withdraws all accumulated SUI including newly earned rewards, but only collects fees based on the stale `collected_rewards` value. The unfee'd rewards are then imported into V2 without any fee calculation, resulting in direct financial loss to the protocol treasury.

## Finding Description

The V1 NativePool's `update_rewards()` function is deprecated and immediately aborts, preventing any updates to the `collected_rewards` field which tracks protocol fees. [1](#0-0) 

However, StakedSui objects continue to earn rewards on-chain through the Sui validator system regardless of this deprecation. The V1 system initializes with a 10% reward fee (`base_reward_fee: 10_00`). [2](#0-1) 

**Vulnerable Migration Flow:**

1. **Export Phase**: The migration's `export_stakes()` function calls `export_stakes_from_v1()` which iterates through all validators and withdraws their StakedSui objects. [3](#0-2) 

2. **Withdrawal Returns All SUI**: The `export_stakes()` helper internally calls `request_withdraw_stake_non_entry()` which returns the complete balance including principal AND all accumulated rewards. [4](#0-3)  This is confirmed by the normal unstaking flow which calculates rewards as the difference between total withdrawn and principal value. [5](#0-4) 

3. **Fee Collection Gap**: The `take_unclaimed_fees()` function reads the frozen `collected_rewards` value and only splits that amount from the migration storage balance. [6](#0-5)  There is no mechanism to calculate fees on newly accrued rewards - the function simply reads the stale value.

4. **Import Without Fee Calculation**: The remaining balance (including unfee'd rewards) is imported to V2 via `join_to_sui_pool()`. [7](#0-6)  This function in the V2 StakePool delegates to ValidatorPool's `join_to_sui_pool()` [8](#0-7)  which simply adds the balance to `total_sui_supply` and joins it to the pool without any fee calculation. [9](#0-8) 

The protocol has no mechanism to recalculate or collect fees on rewards earned between when `update_rewards()` was deprecated and when migration executes. The `collected_rewards` field can only be decreased during unstaking [10](#0-9)  and there is no other public or package function to increase it after `update_rewards()` was deprecated.

## Impact Explanation

**Direct Financial Loss to Protocol:**
- The protocol permanently loses its entitled 10% reward fee on all rewards accrued after the last `update_rewards()` call
- If stakes earned R SUI in rewards after deprecation:
  - Expected protocol fee = 0.10 × R SUI
  - Actual collected = 0 SUI on new rewards  
  - Protocol loss = 0.10 × R SUI
- These unfee'd rewards are transferred to users through the V2 pool instead of being collected by the protocol treasury

**Affected Parties:**
- Protocol treasury loses entitled fees
- Users gain unintended benefit (keeping rewards that should have incurred 10% fees)

**Severity: Medium** - Direct loss of protocol fees (not principal stakes). The loss is bounded by the reward rate and migration timing, but is certain to occur during normal migration operations.

## Likelihood Explanation

**Certainty: 100%**

This issue WILL occur during migration because:

1. **Cannot Be Prevented**: `update_rewards()` is already deprecated in the codebase and cannot be called. [1](#0-0) 

2. **Automatic Reward Accrual**: StakedSui continues earning rewards on-chain through Sui validators regardless of V1 code deprecation. The Sui system's `request_withdraw_stake_non_entry()` automatically includes all accumulated rewards.

3. **Migration Will Execute**: This is a planned one-time administrative operation that will definitely be executed following the documented migration flow. [11](#0-10) 

4. **Time Gap Guarantees Accrual**: Any time gap between deprecation and migration ensures rewards will accrue on the Sui blockchain

**No Attacker Required:**
This is a protocol design flaw in the migration logic, not an attack. It occurs through normal migration flow without any malicious action. Even a trusted admin executing the migration cannot prevent this loss - the code provides no mechanism to collect fees on newly accrued rewards.

## Recommendation

Before executing the migration, add a step to manually calculate and update the `collected_rewards` field to account for all rewards accrued since the last `update_rewards()` call. This requires:

1. Calculate total current value of all StakedSui (principal + rewards)
2. Subtract the tracked principal from `total_staked` 
3. Calculate total rewards = current_value - principal - `total_rewards`
4. Calculate fee on new rewards = new_rewards × 10%
5. Add this fee to `collected_rewards` before calling `take_unclaimed_fees()`

Alternatively, modify the `export_stakes_from_v1()` function to separate principal from rewards and calculate fees dynamically during export, similar to how `remove_stakes()` operates in normal unstaking flow.

## Proof of Concept

The vulnerability can be demonstrated by:

1. Deploy V1 NativePool with StakedSui objects earning rewards
2. Deprecate `update_rewards()` (already done in current code)
3. Wait for rewards to accrue on-chain (automatic via Sui validators)
4. Execute migration flow:
   - Call `export_stakes()` - withdraws all SUI including new rewards
   - Call `take_unclaimed_fees()` - only takes old `collected_rewards` value
   - Call `import_stakes()` - imports remaining balance with unfee'd rewards
5. Verify V2 pool received more SUI than (V1 principal + user rewards after 10% fee)
6. Calculate loss = 10% of (rewards accrued after deprecation)

The protocol will have permanently lost 10% of all rewards earned between deprecation and migration.

### Citations

**File:** liquid_staking/sources/volo_v1/native_pool.move (L170-170)
```text
            base_reward_fee: 10_00, // 10.00%
```

**File:** liquid_staking/sources/volo_v1/native_pool.move (L269-271)
```text
    public entry fun update_rewards(self: &mut NativePool, clock: &Clock, value: u64, _operator_cap: &OperatorCap) {
        abort E_DEPRECATED
    }
```

**File:** liquid_staking/sources/volo_v1/native_pool.move (L470-476)
```text
        if (collectable_reward > self.collected_rewards) {
            // all rewards was collected
            collectable_reward = self.collected_rewards;
            self.collected_rewards = 0;
        } else {
            self.collected_rewards = self.collected_rewards - collectable_reward;
        };
```

**File:** liquid_staking/sources/migration/migrate.move (L1-10)
```text
/// Module: Migration
/// migrate from volo v1 to volo v2
/// migration will be only executed once
/// flow:
/// 1. create stake pool
/// 2. export stakes
/// 3. take unclaimed fees
/// 4. import stakes
/// 5. destroy migration cap
/// 6. unpause the pool (after migration)
```

**File:** liquid_staking/sources/migration/migrate.move (L112-117)
```text
        let validator_set = native_pool.mut_validator_set();
        let (exported_sui, exported_count, exported_sui_amount)
        = export_stakes_from_v1(validator_set, system_state, max_iterations, ctx);

        migration_storage.sui_balance.join(exported_sui);
        migration_storage.exported_count = migration_storage.exported_count + exported_count;
```

**File:** liquid_staking/sources/migration/migrate.move (L144-149)
```text
        let unclaimed_fees = native_pool.mut_collected_rewards();
        let fee_amount = *unclaimed_fees;
        let fees = migration_storage.sui_balance.split(fee_amount);
        transfer::public_transfer(fees.into_coin(ctx), recipient);
        *unclaimed_fees = 0;
        migration_cap.fees_taken = true;
```

**File:** liquid_staking/sources/migration/migrate.move (L173-173)
```text
        stake_pool.join_to_sui_pool(migration_storage.sui_balance.split(amount));
```

**File:** liquid_staking/sources/volo_v1/validator_set.move (L250-256)
```text
            let withdrawn = sui_system::request_withdraw_stake_non_entry(wrapper, staked_sui_to_withdraw, ctx);

            total_withdrawn_principal_value = total_withdrawn_principal_value + principal_value;
            balance::join(&mut total_withdrawn, withdrawn);
        };

        let withdrawn_reward = balance::value(&total_withdrawn) - total_withdrawn_principal_value;
```

**File:** liquid_staking/sources/volo_v1/validator_set.move (L357-357)
```text
            let withdrawn = sui_system::request_withdraw_stake_non_entry(system_state, staked_sui_to_withdraw, ctx);
```

**File:** liquid_staking/sources/stake_pool.move (L552-554)
```text
    public(package) fun join_to_sui_pool(self: &mut StakePool, sui: Balance<SUI>) {
        self.validator_pool.join_to_sui_pool(sui);
    }
```

**File:** liquid_staking/sources/validator_pool.move (L531-534)
```text
    public(package) fun join_to_sui_pool(self: &mut ValidatorPool, sui: Balance<SUI>) {
        self.total_sui_supply = self.total_sui_supply + sui.value();
        self.sui_pool.join(sui);
    }
```
