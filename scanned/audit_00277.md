# Interest Accrual Mismatch

## Summary
The report highlights an inconsistency in the accrual of interest across different pools when a user initiates and completes a flash loan. When a user starts a flash loan, the function to update the state of the lending pool to reflect accrued interest is called. However, if the user repays the loan in a different pool, the function to accrue interest is not called for that pool. This results in an inconsistent state between the borrowing pool and the repayment pool. The report recommends ensuring that interest is accrued for the repayment pool before calling the deposit function. This issue has been fixed in the latest patch.

## Details
## Inconsistency in Flash Loan Interest Accrual

There is an inconsistency in the accrual of interest across different pools when a user initiates and completes a flash loan. When a user starts a flash loan via `start_flashloan`, `accrue_interest(pool)` is called, as shown below. This function updates the state of the lending pool to reflect the accrued interest up to the current moment. This ensures that the pool’s state accurately represents the interest accrued on all outstanding loans.

If the user repays the flash loan in the same pool from which they borrowed, `repay` is called. This function handles the repayment and updates the pool’s state accordingly.

```rust
public(friend) fun start_flashloan(
    user: &signer,
    pool: Object<LendingPool>,
    amount: u64,
): (FungibleAsset, FlashLoanReceipt) acquires InterestRate, Fees, LendingPool, Ltv, State, UserPosition {
    assert_not_paused(pool);
    accrue_interest(pool);
    create_position_if_not_exists(user);
    [...]
}
```

However, if the user deposits the repayment into a different pool via `deposit_internal`, interest is not accrued for the repayment pool before the deposit is made, as highlighted in the code below. This results in an inconsistent state because, while the borrowing pool’s state is updated to reflect the most recent accrued interest, the repayment pool’s state may not reflect the most recent accrued interest since `accrue_interest` is not called for this pool in `end_flashloan`.

```rust
public(friend) fun end_flashloan(
    repayment_pool: Object<LendingPool>,
    repayment: FungibleAsset,
    receipt: FlashLoanReceipt,
) acquires Fees, InterestRate, LendingPool, Ltv, State, UserPosition {
    [...]
    if (borrow_from == repayment_pool) {
        repay(borrower, repayment_pool, repayment);
    } else {
        deposit_internal(borrower, repayment_pool, repayment);
    };
    check_position(borrow_global<UserPosition>(borrower));
}
```

## Remediation

Ensure that interest is accrued for the repayment pool in `end_flashloan` before calling `deposit_internal`.

## Patch

Fixed in `1acebb3`.
