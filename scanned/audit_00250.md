# Possible Abortion Due to Integer Underflow

## Summary
No summary provided.

## Details
## Vulnerability in calculate_fungible_staked_sui_withdraw_amount

The vulnerability in `calculate_fungible_staked_sui_withdraw_amount` within `staking_pool` arises from the subtraction operation used to compute `total_rewards`. This calculation determines how much SUI needs to be withdrawn from the rewards pool by subtracting the principal amount of SUI staked (`fungible_staked_sui_data_principal_amount`) from the total amount of SUI represented by the entire supply of fungible staked SUI tokens (`total_sui_amount`). However, if `total_sui_amount` is less than `fungible_staked_sui_data_principal_amount`, this subtraction will result in a negative value, causing an underflow error and, consequently, an abortion.

>_ sui-framework/packages/sui-system/sources/staking_pool.move rust

```rust
/// written in separate function so i can test with random values
/// returns (principal_withdraw_amount, rewards_withdraw_amount)
fun calculate_fungible_staked_sui_withdraw_amount(
    latest_exchange_rate: PoolTokenExchangeRate,
    fungible_staked_sui_value: u64,
    fungible_staked_sui_data_principal_amount: u64, // fungible_staked_sui_data.principal.value()
    fungible_staked_sui_data_total_supply: u64, // fungible_staked_sui_data.total_supply
) : (u64, u64) {
    // 1. if the entire FungibleStakedSuiData supply is redeemed, how much sui should we receive?
    let total_sui_amount = get_sui_amount(&latest_exchange_rate, fungible_staked_sui_data_total_supply);
    // 2. how much do we need to withdraw from the rewards pool?
    let total_rewards = total_sui_amount - fungible_staked_sui_data_principal_amount;
    [...]
}
```

## Remediation

Check that `total_sui_amount` is greater than or equal to `fungible_staked_sui_data_principal_amount` before performing the subtraction.

## Patch

Resolved in `14050a6`.
