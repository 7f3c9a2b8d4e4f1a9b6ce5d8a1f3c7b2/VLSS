# Document and Clarify Migration Code

## Summary
No summary provided.

## Details
## Module Upgrade and Migration

On module upgrade, it will occasionally be required to perform some additional migration functionality which initializes new structures, copies data, etc.

In the current implementation, migration logic is included in `contract_upgrade::migrate`, which can be optionally called after a contract upgrade. Specifically, on upgrade, the `Migrating` struct is stored on the account, indicating that migration can be performed. At this point, anyone can invoke `contract_upgrade::migrate` to perform the migration and remove the `Migrating` struct marker.

While this implementation properly guards against migration happening more than once, it does not enforce the following properties (that might be expected):

1. Migration code is not required to be run (it is optional, but permissionless).
2. Migration code does not run atomically with the module upgrade.

These properties are potentially unexpected and may lead to situations where developers assume migration code will execute atomically. To safely implement migration code, protocol developers should understand that users may interact with the protocol in between module upgrade and module migration.

## Patch

This has been fixed in `fa01fc1`. Specifically, the documentation has been expanded to clarify the points above. Additionally, a new `is_migrating` function has been added in order to implement features that should be gated until after the migration has been run.

Â© 2022 OtterSec LLC. All Rights Reserved. 12 / 14
