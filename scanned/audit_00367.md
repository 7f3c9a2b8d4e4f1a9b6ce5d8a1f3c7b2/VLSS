# Checking Correct Leaf Linkage

## Summary
No summary provided.

## Details
## B-tree Data Structure

In a B-tree data structure, leaves are commonly interconnected to create a linked list. The next pointer in each leaf directs to the subsequent leaf in the sequence. Merging two leaves implies amalgamating the content of the right leaf with that of the left leaf, thereby excluding the right leaf from the structure.

> _sources/ordered_map.move_
> 
> Merges two leaves by removing the right one and appending its contents to the left one.

```rust
fun merge_leaves<V: copy + drop + store>(map: &mut Map<V>, left: u64, right: u64) {
    let Leaf { keys_vals, next } = df::remove<u64, Leaf<V>>(&mut map.id, right);
    let leaf = df::borrow_mut<u64, Leaf<V>>(&mut map.id, left);
    append_right(&mut leaf.keys_vals, &keys_vals);
    leaf.next = next;
}
```

The check `leaf.next = next` in `merge_leaves` within `ordered_map` is employed to update the next pointer of the left leaf, preserving the linked list structure. However, lacking additional checks, this operation assumes that the next pointer of the left leaf is initially pointed to the right leaf (right). If this assumption is incorrect, unintended consequences may arise, such as disrupting the linked list or pointing to an incorrect leaf.

## Remediation

Add a check in `merge_leaves` to ensure that `leaf.next` is equal to `right` before performing the update.

Â© 2024 Otter Audits LLC. All Rights Reserved. 17/21
