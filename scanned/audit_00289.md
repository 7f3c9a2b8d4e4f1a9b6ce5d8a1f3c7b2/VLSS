# Canceling a vesting plan after its end date will be processed as a claim instead

## Summary
No summary provided.

## Details
##### Description

After creating a vesting plan, users have the option to either claim or cancel them. If a user attempts to call `cancel` before the vesting plan's end date, the current claimable amount will be distributed, and the cancel amount, intended to cover the remaining vesting period, will be returned. This cancel amount can then be utilized, for instance, in `esmkl_token::cancel` to refund any unused esmkl tokens.

However, it's worth noting that the `cancel` function can still be invoked even after the vesting plan's conclusion. In such cases, the logic mirrors that of the `claim` function, albeit with an additional `AdminCapability`. This introduces an ambiguous behavior where a user can effectively claim their tokens through the `cancel` function, despite the vesting plan not being canceled in reality.

Code Location
-------------

The `cancel` function enables users to cancel their vesting plans upon conclusion, resulting in a claim instead.

```
public fun cancel(_vesting_plan: VestingPlan, _claim_cap: ClaimCapability, _admin_cap: AdminCapability): (FungibleAsset, u64) {
    assert!(_vesting_plan.paused == false, E_PAUSED);
    assert!(_vesting_plan.uid == _claim_cap.uid && _vesting_plan.uid == _admin_cap.uid, E_NOT_AUTHORIZED);
    let claimable = get_claimable(&_vesting_plan);
    let claimed_asset = fungible_asset::zero(claimable_fa_store::get_metadata_by_uid(&_vesting_plan.claimable_fa_store_claim_cap));
    if (claimable > 0) {
        fungible_asset::merge(&mut claimed_asset, claim_internal(&mut _vesting_plan, claimable));
    };
    let cancel_amount = _vesting_plan.total_amount - _vesting_plan.claimed_amount;

    (claimed_asset, cancel_amount)
}
```

##### BVSS

[AO:A/AC:L/AX:L/R:F/S:C/C:N/A:N/I:L/D:N/Y:N (0.8)](/bvss?q=AO:A/AC:L/AX:L/R:F/S:C/C:N/A:N/I:L/D:N/Y:N)

##### Recommendation

Consider implementing a check to ensure that the vesting plan's end date has not been reached before allowing cancellation. This requirement will compel users to claim their plans through the `claim` function, as intended.

Remediation Plan
----------------

**SOLVED:** The **Taurus Labs team** revised the logic to ensure that a vesting plan cancellation is permissible only when the cancellation amount exceeds zero.

##### Remediation Hash

<https://github.com/tauruslabs/merkle-contract/commit/bd07356146859ac75f9bf66c1b698486a4d40cb1>

##### References

[tauruslabs/merkle-contract/merkle-token/sources/vesting.move#L118](https://github.com/tauruslabs/merkle-contract/blob/8b9d5bb6a65adfd62654daaba4061287714b2594/merkle-token/sources/vesting.move#L118)
