# Immediate Liquidation Risk via MMR Update

## Summary
The client has acknowledged an issue with the `perpetual::set_maintenance_margin_required()` function, which allows the Exchange Manager to update the Maintenance Margin Ratio (MMR) for a perpetual market. This can lead to mass liquidations without user action or market movement, potentially causing significant user losses and system instability. The exploit scenario involves a user's position becoming immediately liquidatable after the MMR is increased. The report recommends implementing a timelock or grace period for MMR increases, removing the function altogether, or gradually increasing the MMR.

## Details
**Update**
Marked as "Acknowledged" by the client. Addressed in: `6d1e07cd32e541c1a8502a21cde137ca1dec03e9`. The client provided the following explanation:

> We added documentation for this function.

**File(s) affected:**`perpetual.move`

**Description:** The `perpetual::set_maintenance_margin_required()` function allows the Exchange Manager to update the Maintenance Margin Ratio (MMR) for a perpetual market. This change takes effect immediately for all existing positions. If the MMR is increased, positions that were previously safe (margin ratio > old MMR) but are below the new MMR (margin ratio < new MMR) become immediately liquidatable. This can lead to mass liquidations without user action or market movement, potentially causing significant user losses and system instability.

**Exploit Scenario:**

1.   A user has a position with a margin ratio of 6%. The current MMR is 5%. The position is safe.
2.   The Exchange Manager calls `set_maintenance_margin_required()` to increase the MMR to 7%.
3.   The user's position (6%) is now less than the new MMR (7%).
4.   The liquidator calls `exchange::liquidate()` on the user's position.
5.   The user is liquidated immediately, losing their position and paying liquidation penalties.

**Recommendation:** Implement a timelock or a grace period for MMR increases. For example, announce the new MMR but only apply it after a delay (e.g., 7 days), allowing users to adjust their positions or add margin. Alternatively, apply the new MMR only to new positions or gradually increase it. Another option is to remove the function altogether since it presents a significant risk to users.
