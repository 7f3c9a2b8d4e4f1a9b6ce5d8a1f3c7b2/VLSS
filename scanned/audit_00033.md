# `VaultNAV` Calculation Exceeds Object Limits as Market Count Grows, Causing Denial of Service for All Vault Operations

## Summary
No summary provided.

## Details
**Update**
Marked as "Acknowledged" by the client. The client provided the following explanation:

> For a considerable period of time, the number of contract markets we plan to launch will not exceed 50, the current solution is sufficient for use. In addition, the solution you recommended has potential security risks of being attacked, as traders' opening/closing positions operations are not synchronized with the register_market process.

**File(s) affected:**`vault.move`

**Description:** The `VaultNAV` logic iterates through every perpetual market registered in the `ProtocolConfig` to calculate the Vault's total Net Asset Value (NAV). This occurs in `new_vault_nav()` and `compute_perpetual_position_value()`.

Sui enforces a strict limit of **1,000 unique dynamic field accesses** per transaction block (PTB).

For each perp market, `compute_perpetual_position_value()` performs the following operations:

1.   `nav.position_values.contains(perp_id)`&`nav.position_values.add(perp_id, ...)`: Accesses the unique field for this perp in the NAV table.
2.   `perp.has_position(vault_address)`&`perp.borrow_position(vault_address)`: Accesses the unique field for this vault in the Perpetual's position table.

Once the protocol deploys approximately **500 markets**, the transaction will hit the 1,000 unique dynamic field limit. Since `deposit()`, `withdraw()`, `distribute_funds()`, and `close_vault()` all require `VaultNAV`, all user funds will be locked in every Vault.

**Recommendation:** Refactor the `Vault` to track its own "Active Markets" instead of iterating the global list.

1.   **Add Registry**: Add a `VecSet<ID>` field to the `Vault` struct to store `enabled_markets`.
2.   **Update NAV**: Modify `VaultNAV` to iterate only over `vault.enabled_markets`.
3.   **Permissionless Registration**: Add a function `register_market(vault, perp)` that adds a market to the Vault's list.
4.   **Anti-Exploit Mechanism**: To prevent a malicious trader from hiding losing positions (by not registering the market), implement a permissionless `force_register()` function. This allows any user (or a keeper bot) to prove the Vault has a position in an unregistered market, forcing it into the list and ensuring the NAV remains accurate.
