# Double Counting Rewards

## Summary
No summary provided.

## Details
## Accumulate Rewarder and Strategy Update

The function `rewarder::accumulate_rewarder_released` and `accumulate_strategy_reward` update the `total_reward_released` for the entire rewarder based on the emission rate and elapsed time. However, `accumulate_strategy_reward` does not update the `last_reward_time` for the rewarder unlike `accumulate_rewarder_released`.

## Code Snippet

```rust
// rewarder.mover.rs
public(friend) fun accumulate_rewarder_released(rewarder: &mut Rewarder, current_time: u64) {
    if (rewarder.last_reward_time <= current_time) {
        let elapsed_time = current_time - rewarder.last_reward_time;
        if (rewarder.emission_per_second > 0) {
            let additional_rewards = rewarder.emission_per_second * elapsed_time;
            rewarder.total_reward_released = rewarder.total_reward_released + (additional_rewards as u128);
        };
        rewarder.last_reward_time = current_time;
    }
}
```

Thus, when `strategy_rewards_settle` calls `accumulate_rewarder_released` for each rewarder, it updates the `total_reward_released` for the entire rewarder based on the current time and elapsed times since the `last_reward_time` of the rewarder. The subsequent call to `accumulate_strategy_reward` also calculates the elapsed time considering the last reward time of the strategy, which may be different from the last reward time of the rewarder.

```rust
// rewarder.mover.rs
public(friend) fun accumulate_strategy_reward(
    rewarder: &mut Rewarder,
    strategy_id: ID,
    strategy_share: u128,
    current_time: u64
): u128 {
    [...]
    if (current_time > strategy_info.last_reward_time && rewarder.emission_per_second > 0) {
        [...]
        rewarder.total_reward_released = rewarder.total_reward_released + (new_rewards_total as u128);
    };
    [...]
}
```

## Audit Observations

© 2024 Otter Audits LLC. All Rights Reserved.

### Vulnerabilities
Since `accumulate_strategy_reward` does not update the `last_reward_time` of the rewarder, the elapsed time it calculates may include a period already accounted for in the previous call to `accumulate_rewarder_released`. As a result, the `total_reward_released` for the rewarder increments twice for the same elapsed time, double-counting the `total_reward_released` value.

## Remediation
Split the rewards calculations logic into two steps: strategy’s rewards calculation and the global rewarder’s rewards calculations.

### Patch
Resolved in commit `971cfd9`.

© 2024 Otter Audits LLC. All Rights Reserved.
