# SQL Injection In Points API Route

## Summary
No summary provided.

## Details
## Security Report

## Severity: Low Risk

### Description
The `GET()` handler in `echelon/app/api/cron/points/route.txs` contains two SQL injection vulnerabilities. While the likelihood of exploitation is low since both injection points rely on trusted 3rd party data sources, following security best practices would suggest using parameterized queries in both cases.

1. **Error Message SQL Injection**: In the catch block of the `GET()` handler, error messages are directly interpolated into an SQL query string:

   ```javascript
   catch (e) {
       console.error(e);
       const message: string = e instanceof Error ? e.message : String(e);
       await client.query(`
           INSERT INTO points_snapshot_status (success, error_message)
           VALUES (FALSE, '${message}');`);
   }
   ```

2. **Points Data SQL Injection**: When inserting points data from the `fetchAllPoints()` response:

   ```javascript
   const values = data
       .map(
           (item) => `(
               '${item.account}',
               ${item.borrowPoints},
               ${item.lendPoints},
           )`
       )
       .join(",");
   ```

Both cases involve direct string concatenation into SQL queries without parameterization. The `VALUES` clause structure makes it possible to break out of both the string context and parentheses using a payload like `') <malicious SQL> --`.

An attacker who could control either error messages or points data could potentially execute arbitrary SQL commands. However, since both data sources are trusted internal systems, the actual risk of malicious exploitation is low.

The likelihood of exploitation is low since both vulnerabilities require control of trusted data sources - either internal error messages or the points API response. However, the technical complexity of exploitation is also low due to the direct string concatenation and simple injection pattern.

### Recommendation

1. **For error handling**:

   ```javascript
   catch (e) {
       console.error(e);
       const message: string = e instanceof Error ? e.message : String(e);
       await client.query(
           'INSERT INTO points_snapshot_status (success, error_message) VALUES ($1, $2)',
           [false, message]
       );
   }
   ```

2. **For points data**:

   ```javascript
   const valueParams = data.map((_, i) => `($${i * 3 + 1}, $${i * 3 + 2}, $${i * 3 + 3}, 0)`).join(',');
   const flatValues = data.flatMap(item => [
       item.account,
       item.borrowPoints,
       item.lendPoints
   ]);
   await client.query(`
       INSERT INTO points_snapshot (account, borrow_points, lend_points, referral_points)
       VALUES ${valueParams}
   `, flatValues);
   ```
