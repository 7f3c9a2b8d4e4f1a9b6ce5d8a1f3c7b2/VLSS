# Payment Failure

## Summary
No summary provided.

## Details
## Code Review: `controller.move`

In `controller.move`, `register_internal` checks the user’s coin value before applying discount and referral codes. This may lead to a program aborting if the valid payment exceeds the registration fee after applying the codes.

## Relevant Code Snippet

```rust
fun register_internal(
    suins: &mut SuiNS,
    config: &mut Configuration,
    label: vector<u8>, // label has only 1 level
    owner: address,
    no_years: u64,
    secret: vector<u8>,
    payment: &mut Coin<SUI>,
    referral_code: Option<ascii::String>,
    discount_code: Option<ascii::String>,
    signature: vector<u8>,
    hashed_msg: vector<u8>,
    raw_msg: vector<u8>,
    clock: &Clock,
    ctx: &mut TxContext,
) {
    [...]
    assert!(coin::value(payment) >= registration_fee, ENotEnoughFee);
    // can apply both discount and referral codes at the same time
    if (option::is_some(&discount_code)) {
        registration_fee =
            apply_discount_code(config, registration_fee,
            ,→ option::borrow(&discount_code), ctx);
    };
    if (option::is_some(&referral_code)) {
        registration_fee =
            apply_referral_code(config, payment, registration_fee,
            ,→ option::borrow(&referral_code), ctx);
    };
    [...]
}
```

## Remediation

Move the check for the value of the user’s coin to after the application of discount and referral codes. This ensures that valid payments greater than the registration fee after the application of the codes are not aborted by the program.
