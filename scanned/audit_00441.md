# Unfinished Crank Process

## Summary
No summary provided.

## Details
## Concerns Regarding epoch_was_changed

There are several concerns if `epoch_was_changed` does not complete all processes before advancing to the next epoch:

1. **Sorting Key**: The `sorting_key` is determined based on the SUI amount and token amount of the pool that existed at the current epoch and the previous epoch (epoch - epoch_gap). If processing finishes up to `sorting_key` and then transitions to the next epoch, the `sorting_keys` become outdated keys, which could affect the `sorting_deque` and the unstake process that uses those values.

2. **Total SUI Amount Calculation**: The total SUI amount for the pool is calculated by taking the current exchange rate and the exchange rate from the activation epoch, and calculating the actual value of pool tokens. However, if this process is finished in `epochX`, but the next step will be executed in `epochX + 1`, these values calculated at `epochX` will be outdated if the new rewards were accrued.

## Remediation

The epoch to be processed by `epoch_was_changed` is determined by adding one to `active_epoch` stored in the state, and `active_epoch` is designed to increase by one. This approach ensures that when the difference between the current epoch and the epoch in the state becomes two or more, the crank process advances one by one epoch.

When querying information that could vary with the epoch, such as the exchange rate or SUI reward, specifying the epoch is mandatory, preventing the protocol from using the information from a different epoch.

## Patch

Fixed in commit `b375014` by preparing for the unfinished crank process before the advance of the epoch.
