# Non Atomic Upgrade And Migrate

## Summary
No summary provided.

## Details
## Wormhole and Token Bridge Upgrade Implementation

The original implementation of wormhole and token_bridge upgrade consists of two steps:

1. Upgrade the package through the native Sui upgrade command.
2. Custom migration logic facilitates the switch from old to new modules.

Due to a circular dependency between `storageId` of the newly deployed package and the hash of `BatchTransaction` that includes the upgrade transaction, it is generally not possible to call functions on new modules within the same `BatchTransaction` where the upgrade command is included. This limitation forces wormhole and token_bridgeâ€™s upgrade and migrate to be performed in two different transactions and exposes a window where other transactions may be called on both new and old packages after the upgrade occurs but before migration is completed.

## Remediation

The Wormhole team has decided to rework the upgrade flow to:

1. Minimize public functions that should be used by external integrator packages. This simplifies version control logic by removing modular upgrades and opting for a singular version across all modules.
2. Add a version toggle that would get activated upon calling migrate. This ensures that before migrate occurs, only functions from an old package with APIs compatible with the pre-migrate state may be called.

## Patch

Resolved in `760db3c`.
