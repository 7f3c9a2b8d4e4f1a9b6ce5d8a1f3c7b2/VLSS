# Use of ExtendRef to create a signer for rewards transfer in staked_lpt.move#L897 

## Summary
No summary provided.

## Details
## Functionality Details

## Verification Status

| Functionality                             | Details                                                                                                           | Status |
|-------------------------------------------|-------------------------------------------------------------------------------------------------------------------|--------|
| **stake**                                  | Processes stake actions, ensuring the resources and conditions are correct before accepting any stake. Verification is enabled to maintain consistency with the protocol rules. | ✓      |
| - Abort Conditions                        | Aborts if the Farming resource does not exist or if staking is paused.                                          | ✓      |
| - Required Resource Check                 | Ensures metadata for the stakeable asset (lpt) exists and is valid.                                             | ✓      |
| - Amount Conservation                     | Ensures the amount of staked tokens matches the output result.                                                  | ✓      |
| - Field Consistency                       | Ensures all other critical fields in the Farming resource remain unchanged.                                      | ✓      |
| **set_max_boost_multiplier_bps**         | Allows the protocol owner or an authorized manager to set the maximum boost multiplier. Verification is enabled to ensure proper authorization and state consistency. | ✓      |
| - Abort Conditions                        | Aborts if the manager resource is uninitialized or if the caller is unauthorized.                                | ✓      |
| - Max Boost Multiplier Check              | Ensures the max_boost_multiplier_bps field is updated correctly.                                                | ✓      |
| - Field Consistency                       | Ensures all other fields in the Farming resource remain unchanged.                                               | ✓      |
| **claim_reward**                          | Allows users to claim rewards from staking. Verification is enabled to ensure all conditions are met before allowing reward claims. | ✓      |
| - Abort Condition                         | Aborts if the Farming resource does not exist.                                                                    | ✓      |
| - Field Consistency                       | Ensures fields related to staking, un-staking, and reward metadata remain consistent during the reward claim process. | ✓      |

## Module Definition

``` 
pragma verify = false; 
```
By default, verification is disabled at the module level, meaning the module will not perform automatic verification for every operation unless explicitly specified.

### unstake_paused

This function checks if the "unstake" functionality is paused.

``` 
pragma verify = true; 
```
Verification is enabled specifically for this function to ensure that all conditions are validated before execution.

- **Abort Condition**  
  `aborts_if !exists<Farming>(package::package_address());`  
  The function aborts if the Farming resource does not exist at the given address, ensuring the correct protocol state is present before attempting any actions.

- **Return Value Consistency**  
  `ensures result == global<Farming>(package::package_address()).unstake_paused;`  
  The return value of the function must match the current unstake_paused state in the Farming resource. This guarantees that the function reads the latest state accurately.

- **Field Consistency**  
  Purpose: These checks verify that all other critical fields in the Farming resource remain unchanged, ensuring the integrity of the protocol state.
  
  ```
  ensures global<Farming>(package::package_address()).stake_paused == farming.stake_paused;
  ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
  ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
  ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
  ensures global<Farming>(package::package_address()).reward_id_to_metadata == farming.reward_id_to_metadata;
  ensures global<Farming>(package::package_address()).pool_id_to_metadata == farming.pool_id_to_metadata;
  ```

### stake_paused

This function checks if staking is paused.

``` 
pragma verify = true; 
```
Verification is enabled for this function to ensure state integrity is maintained when fetching the staking pause status.

- **Abort Condition**  
  `aborts_if !exists<Farming>(package::package_address());`  
  Similar to unstake_paused, this ensures that the Farming resource exists before interacting with it.

- **Return Value Consistency**  
  `ensures result == global<Farming>(package::package_address()).stake_paused;`  
  Verifies that the function correctly reads and returns the stake_paused state from the global Farming resource.

- **Field Consistency**  
  Purpose: These checks ensure that other fields in the Farming resource are not modified unexpectedly when querying stake_paused.
  
  ```
  ensures global<Farming>(package::package_address()).unstake_paused == farming.unstake_paused;
  ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
  ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
  ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
  ensures global<Farming>(package::package_address()).reward_id_to_metadata == farming.reward_id_to_metadata;
  ensures global<Farming>(package::package_address()).pool_id_to_metadata == farming.pool_id_to_metadata;
  ```

### stake

This function is responsible for processing stake actions, ensuring the resources and conditions are correct before accepting any stake.

``` 
pragma verify = true; 
```
Verification is enabled for this function to maintain consistency with the protocol rules when processing stakes.

- **Abort Conditions**  
  `aborts_if !exists<Farming>(package::package_address());`  
  Ensures that the Farming resource is available before proceeding. Without this, a transaction could attempt to stake without a valid farming resource, leading to undefined behavior.
  
  `aborts_if stake_paused();`  
  Prevents staking if the stake_paused status is true, ensuring that staking cannot occur during pause periods.

- **Required Resource Check**  
  `let lpt_metadata = fungible_asset::asset_metadata(lpt);`  
  This ensures that metadata for the stakeable asset (lpt) exists and is valid before proceeding.

- **Amount Conservation**  
  `ensures fungible_asset::amount(result) == fungible_asset::amount(lpt);`  
  Verifies that the amount of staked tokens (lpt) matches the output result. This guarantees that no tokens are lost or erroneously created during the staking process.

- **Field Consistency**  
  Purpose: These checks prevent unintended side effects by verifying that other critical fields remain unchanged.
  
  ```
  ensures global<Farming>(package::package_address()).stake_paused == farming.stake_paused;
  ensures global<Farming>(package::package_address()).unstake_paused == farming.unstake_paused;
  ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
  ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
  ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
  ```

### set_max_boost_multiplier_bps

This function allows the protocol owner or an authorized manager to set the maximum boost multiplier.

``` 
pragma verify = true; 
```
Verification is enabled for this function to ensure proper authorization and state consistency before modifying the boost multiplier.

- **Abort Conditions**  
  `aborts_if !manager::initialized() with manager::ERR_MANAGER_UNINITIALIZED;`  
  Ensures the manager resource is initialized before any changes are made.

  `aborts_if manager::initialized() && !manager::is_authorized(manager) with ERR_STAKED_LPT_UNAUTHORIZED;`  
  Ensures only authorized managers can make this change, enforcing the security and governance of the protocol.

- **Max Boost Multiplier Check**  
  `ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == bps;`  
  Confirms that the max_boost_multiplier_bps field is updated correctly.

- **Field Consistency**  
  Ensures all other fields in the Farming resource remain unchanged as a result of this action.

### claim_reward

This function is for claiming rewards from staking.

``` 
pragma verify = true; 
```
Verification is enabled for this function to ensure all conditions are met before allowing reward claims.

- **Abort Condition**  
  `aborts_if !exists<Farming>(package::package_address());`  
  Verifies that the Farming resource exists before allowing a claim.

- **Field Consistency**  
  Verifies that fields related to staking, un-staking, and reward metadata remain consistent during the reward claim process.

## See the Source Below:

```
spec thala_staked_lpt::staked_lpt {
  spec module {
    pragma verify = false; // Disable verification by default
  }
  spec unstake_paused {
    pragma verify = true; // Enable only for this function
    aborts_if !exists<Farming>(package::package_address());
    ensures result == global<Farming>(package::package_address()).unstake_paused;
    // Ensures Field Consistency - other fields remain unchanged
    let farming = global<Farming>(package::package_address());
    ensures global<Farming>(package::package_address()).stake_paused == farming.stake_paused;
    ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
    ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
    ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
    ensures global<Farming>(package::package_address()).reward_id_to_metadata == farming.reward_id_to_metadata;
    ensures global<Farming>(package::package_address()).pool_id_to_metadata == farming.pool_id_to_metadata;
  }
  spec stake_paused {
    pragma verify = true; // Enable only for this function
    aborts_if !exists<Farming>(package::package_address());
    ensures result == global<Farming>(package::package_address()).stake_paused;
    // Ensures Field Consistency - other fields remain unchanged
    let farming = global<Farming>(package::package_address());
    ensures global<Farming>(package::package_address()).unstake_paused == farming.unstake_paused;
    ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
    ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
    ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
    ensures global<Farming>(package::package_address()).reward_id_to_metadata == farming.reward_id_to_metadata;
    ensures global<Farming>(package::package_address()).pool_id_to_metadata == farming.pool_id_to_metadata;
  }
  spec stake {
    pragma verify = true;
    pragma aborts_if_is_partial = true;
    // Core safety checks
    aborts_if !exists<Farming>(package::package_address());
    aborts_if stake_paused();
    // Required resources exist
    let lpt_metadata = fungible_asset::asset_metadata(lpt);
    // Amount conservation - ensure output amount matches input
    ensures fungible_asset::amount(result) == fungible_asset::amount(lpt);
    // Ensures Field Consistency - control fields remain unchanged
    let farming = global<Farming>(package::package_address());
    ensures global<Farming>(package::package_address()).stake_paused == farming.stake_paused;
    ensures global<Farming>(package::package_address()).unstake_paused == farming.unstake_paused;
    ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
    ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
    ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
    ensures global<Farming>(package::package_address()).reward_id_to_metadata == farming.reward_id_to_metadata;
  }
  spec set_max_boost_multiplier_bps {
    pragma verify = true;
    // Only authorized managers can call this function
    aborts_if !manager::initialized() with manager::ERR_MANAGER_UNINITIALIZED;
    aborts_if manager::initialized() && !manager::is_authorized(manager) with ERR_STAKED_LPT_UNAUTHORIZED;
    // The Farming resource must exist
    aborts_if !exists<Farming>(package::package_address());
    // Ensures the max_boost_multiplier_bps is updated correctly
    let farming = global<Farming>(package::package_address());
    ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == bps;
    // Ensures other fields remain unchanged
    ensures global<Farming>(package::package_address()).stake_paused == farming.stake_paused;
    ensures global<Farming>(package::package_address()).unstake_paused == farming.unstake_paused;
    ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
  }
  spec claim_reward {
    pragma verify = true;
    pragma aborts_if_is_partial = true;
    pragma timeout = 60; // Increase timeout to 60 seconds
    // safety checks
    aborts_if !exists<Farming>(package::package_address());
    // State consistency
    let farming = global<Farming>(package::package_address());
    ensures global<Farming>(package::package_address()).stake_paused == farming.stake_paused;
    ensures global<Farming>(package::package_address()).unstake_paused == farming.unstake_paused;
    ensures global<Farming>(package::package_address()).boost_scaling_factor_bps == farming.boost_scaling_factor_bps;
    ensures global<Farming>(package::package_address()).max_boost_multiplier_bps == farming.max_boost_multiplier_bps;
    ensures global<Farming>(package::package_address()).reward_store_extend_ref == farming.reward_store_extend_ref;
    ensures global<Farming>(package::package_address()).reward_id_to_metadata == farming.reward_id_to_metadata;
    ensures global<Farming>(package::package_address()).pool_id_to_metadata == farming.pool_id_to_metadata;
  }
}
```
