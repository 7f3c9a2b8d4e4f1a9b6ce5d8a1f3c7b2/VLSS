# Extract Metadata from Capabilities

## Summary
No summary provided.

## Details
## Tortuga Protocol Access Control

The Tortuga protocol makes use of several capability resources to provide access control to various functions. For example, `delegation_service` provides a `ManageCapability` to the protocol when it registers new validators.

However, current validation of capability resources happens in a non-canonical way. For example:

```move
public fun pay_commission_to_owner(
    managed_pool_address: address,
    manage_cap: &ManageCapability,
): u64 {
    assert_pool_exists(managed_pool_address);
    assert!(manage_cap.managed_pool_address == managed_pool_address,
            error::unauthenticated(EPERMISSION_DENIED));
    delegation_state::pay_commission_to_owner(managed_pool_address)
}
```

In this snippet, `manage_cap` contains a `managed_pool_address` which it can operate on. It is not necessary to include this as a second argument and use an assertion to check equality. In fact, this pattern is more dangerous because forgetting an assertion could lead to mishandling the capability (i.e., an attacker might be able to operate on the wrong pool).

## Remediation

It is recommended to derive any necessary data from the capability resource directly to simplify logic and ensure that the operation acts on the correct target for the given capability. 

The code above could be refactored to:

```move
public fun pay_commission_to_owner(
    manage_cap: &ManageCapability,
): u64 {
    assert_pool_exists(manage_cap.managed_pool_address);
    delegation_state::pay_commission_to_owner(
        manage_cap.managed_pool_address
    )
}
```

---

© 2022 OtterSec LLC. All Rights Reserved. 

## Tortuga Audit 05 | General Findings

### Patch

Resolved in ef89a88.

© 2022 OtterSec LLC. All Rights Reserved.
