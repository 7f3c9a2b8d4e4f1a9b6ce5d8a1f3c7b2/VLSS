# Add A Flag

## Summary
No summary provided.

## Details
## Document Title

## Overview

The `native_pool::sort_validators` is responsible for sorting the validators list based on their priorities. It necessitates manual invocation. However, there is no built-in mechanism that guarantees the automatic execution of this function subsequent to the updating of priorities via `native_pool::update_validators`.

### Stake Pool Functionality

`stake_pool` stakes the `NativePool::pending SUI` to the validator positioned at the top of the list. It is worth noting that, in a worst-case scenario, the validator occupying the top position may no longer be active, with their priority set to zero.

## Remediation

Introduce a new flag called `is_sorted: bool`, which will be modified as follows:

1. In `native_pool::update_validators`, set `is_sorted = false`.
2. In the `native_pool::sort_validators` function, set `is_sorted = true`.

Additionally, we propose implementing a check of this flag each time a user intends to add stake.

## Code Changes

### native_pool.move DIFF

```rust
// native_pool::NativePool
validator_set: ValidatorSet, // pool validator set
+ is_sorted: bool, // track if the validators are sorted
ticket_metadata: unstake_ticket::Metadata,
/* Store active stake of each epoch */
@@ -166,6 +166,7 @@ module liquid_staking::native_pool {
base_reward_fee: 10_00, // 10.00%
min_stake: ONE_SUI,
validator_set: validator_set::create(ctx),
+ is_sorted: false,
ticket_metadata: unstake_ticket::create_metadata(ctx),
base_unstake_fee: 5, // 0.05%
...
```

### native_pool::update_validators

```rust
validator_set::update_validators(&mut self.validator_set, validators,
,→ priorities);
+ self.is_sorted = false;
}
...
```

### native_pool::stake_pool

```rust
let validator = validator_set::get_top_validator(&mut self.validator_set);
let staked_sui = sui_system::request_add_stake_non_entry(wrapper,
,→ pending_stake, validator, ctx);
+ if (!self.is_sorted) {
Volo Audit 05 | General Findings
+ sort_validators(self);
+ };
validator_set::add_stake(&mut self.validator_set, validator, staked_sui,
,→ ctx);
add_total_staked_unsafe(self, pending_value, ctx);
...
```

### native_pool::sort_validators

```rust
validator_set::sort_validators(&mut self.validator_set);
+ self.is_sorted = true;
}
```

## Patch

In response, the Volo team has noted that the functions `native_pool::update_validators` and `native_pool::sort_validators` are typically invoked within the same transaction. As a solution, the team has introduced a `NativePool::is_sorted` flag. However, the validation of this flag has not yet been included within `native_pool::stake_pool`.

Published in 8099e49.
