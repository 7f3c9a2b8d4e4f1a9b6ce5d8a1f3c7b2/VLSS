# Forced Eviction Of Legit Orders

## Summary
No summary provided.

## Details
## AVL Queue Order Eviction

AVL queue evicts orders when the tree exceeds a `CRITICAL_HEIGHT` or when the number of active nodes becomes equal to `N_NODES_MAX`, to prevent excessive gas costs for insertion and deletion. In theory, due to the limited orderbook capacity, an attacker can place enough orders to evict legitimate orders and then cancel these placed orders.

## Proof of Concept

We profiled the gas required to fill up the whole tree and then replace all the legit orders from the tree. See [Gas Profiling POC](#).

### Before Patch:
- It took approximately 3 transactions to fill up the tree.
- To evict all existent legit orders, it took approximately 6 transactions.

## Remediation

One easy mitigation would be to increase the height of the tree. Currently, the `CRITICAL_HEIGHT` of the tree is set to `10`, which can hold `2048` unique priced orders. Increasing the `CRITICAL_HEIGHT` of the tree can make it more expensive to evict all orders.

### RUST

| Height | Minimum Size | Maximum Size |
|--------|--------------|--------------|
| 10     | 232          | 2047         | <--- |
| 13     | 986          | 16383 (`n_max`) |
| 18 (`h_max`) | 10945 | 524287     |

Unfortunately, there is a hard limit on how much we can increase the tree height. We profiled the eviction gas after the patch, and it increases the number of transactions required by around 6x. While this isnâ€™t perfect, it does represent a decent mitigation.

### After Patch:
- It took approximately 20 transactions to fill up the tree.
- To evict all existent legit orders, it took approximately 37 transactions.

As an additional mitigation, a minimum order and tick size should be chosen.

## Econia Labs Audit 04 | Vulnerabilities

### Patch

Patch added in commit `9b3cada`.

**File**: `src/move/econia/sources/market.move`

```diff
@@ -634,7 +634,7 @@ module econia::market {
- const CRITICAL_HEIGHT: u8 = 10;
+ const CRITICAL_HEIGHT: u8 = 18;
}
```
