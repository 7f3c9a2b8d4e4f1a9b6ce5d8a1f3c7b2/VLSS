# Extract Metadata From Capabilities

## Summary
No summary provided.

## Details
## Tortuga Protocol Access Control

The Tortuga protocol uses several capability resources to provide access control to various functions. For example, `delegation_service` provides a `ManageCapability` to the protocol when registering new validators.

However, the current validation of capability resources occurs in a non-canonical way. For example:

```move
public fun pay_commission_to_owner(
    managed_pool_address: address,
    manage_cap: &ManageCapability,
): u64 {
    assert_pool_exists(managed_pool_address);
    assert!(manage_cap.managed_pool_address == managed_pool_address,
        error::unauthenticated(EPERMISSION_DENIED));
    delegation_state::pay_commission_to_owner(managed_pool_address)
}
```

In the snippet above, `manage_cap` contains a `managed_pool_address`, which it may operate on. Including this as a second argument and using an assertion to check equality is unnecessary. This pattern is dangerous as forgetting an assertion may lead to mishandling the capability (i.e., an attacker may be able to operate on the wrong pool).

## Remediation

Derive any necessary data from the capability resource directly to simplify logic and ensure that the operation acts on the correct target for the given capability. The code above could be refactored to:

```move
public fun pay_commission_to_owner(
    manage_cap: &ManageCapability,
): u64 {
    assert_pool_exists(manage_cap.managed_pool_address);
    delegation_state::pay_commission_to_owner(
        manage_cap.managed_pool_address
    )
}
```

---

© 2023 OtterSec LLC. All Rights Reserved.  
Tortuga Audit 05 | General Findings  
Patch  
Resolved in ef89a88.  
© 2023 OtterSec LLC. All Rights Reserved.
