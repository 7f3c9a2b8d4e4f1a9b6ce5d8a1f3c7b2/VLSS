# Orphaned Perpetual Positions due to Incomplete Closure Check

## Summary
No summary provided.

## Details
**Update**
The issue was addressed in: `c5ae76b85744cf25ed6d3cb4e728981dccd3157d`.

**File(s) affected:**`vault.move`

**Description:** The `close_vault()` function intends to ensure a vault has no open positions before allowing closure, asserting `nav.position_nav == 0`. However, `nav.position_nav` is calculated in `compute_perpetual_position_value()` using `.positive_value()`, which clamps negative position values (underwater positions) to zero. This means a vault with open, underwater positions (where PnL loss > margin) can be closed and subsequently removed. While this scenario is extremely unlikely—as such positions would typically be liquidated long before a vault closure is attempted—it remains theoretically possible. When `remove_vault()` deletes the `Vault` object, the corresponding `Position` in the `Perpetual` contract remains in storage but becomes permanently inaccessible. If the market price recovers, the locked margin and potential profits in that position are lost forever as the owner (the vault) no longer exists.

**Recommendation:** In `close_vault()`, instead of relying on `nav.position_nav`, the function should explicitly verify that the vault has no active positions in any market. This requires iterating through all perpetual markets and checking `!perp.has_position(vault_address)`.

Alternatively, update the documentation and function comments to clarify that `close_vault()` is permitted when the vault's Net Asset Value (NAV) is zero, even if open positions exist (provided they have zero value).
