# DOS While Removing Shares From Reserve

## Summary
The bug report discusses an issue in the profile.move function where the try_subtract_profile_reward_share function is not properly handling cases where a farm does not exist for a specific reserve type. This leads to incorrect subtraction of shares in the reserve::try_remove_reserve_reward_share function, resulting in an error when a user tries to withdraw their collateral. The bug has been fixed in the code and the issue has been resolved.

## Details
## Profile Move - `try_subtract_profile_reward_share` Function

In `profile.move`, the `try_subtract_profile_reward_share` function checks whether the profile has a farm for that specific reserve type while subtracting shares from a profile farm. If a farm doesn’t exist, the reward for that reserve is created after the profile is created, so the function skips the subtraction of shares.

This case is not handled while subtracting shares from the reserve farm in the `reserve::try_remove_reserve_reward_share` function. This leads to the subtraction of shares that were previously absent in the reserve.

## Proof of Concept

Consider the following scenario:

1. A reserve is created.
2. A user (user1) mints and deposits collateral to the reserve. Since the farm doesn’t have any rewards, no shares are added to `reserve_farm` or `profile_farm`.
3. A reward is added to the `reserve_farm` for that reserve.
4. Another user (user2) mints and deposits collateral to the reserve. Since there is a `reserve_farm`, shares are added to the `reserve_farm` and `profile_farm`.
5. If user1 removes their collateral while they have no shares in their `profile_farm`, no shares are subtracted from their profile farm. Shares are still removed from their `reserve_farm`.
6. Now if user2 tries to withdraw their collateral, the `reserve_farm` gives an error since user1 has subtracted shares from the `reserve_farm`.

## Remediation

A possible method of remediation is ensuring the amount of shares subtracted from the `reserve_farm` is equal to the amount of shares subtracted from the `profile_farm`.

## Patch

Resolved in `7f0519d`.

© 2022 OtterSec LLC. All Rights Reserved. 9 / 19
