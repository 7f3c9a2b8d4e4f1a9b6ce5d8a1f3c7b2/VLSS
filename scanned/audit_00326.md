# Potential Balance Misallocation

## Summary
No summary provided.

## Details
## Summary of get_transaction Behavior

In `get_transaction`, the call to `sweep` is not explicitly enforced to occur after the call to `swap`. If the program calls `SWAP_TYPE_SWEEP_DUST` before `SWAP_TYPE_DEEPBOOK_V2`, or if there is no `SWAP_TYPE_DEEPBOOK_V2` call, all balances of the base coin (supposedly remaining coins after the swap) will be stored in the `coin_bag` of the Squid router in `sweep`.

> _sources/squid/discovery.move rust_

```rust
public fun get_transaction(squid: &Squid, its: &ITS, payload: vector<u8>): Transaction {
    [...]
    while(i < vector::length(&swap_data)) {
        [...]
        vector::push_back(
            &mut move_calls,
            if (swap_type == SWAP_TYPE_SWEEP_DUST) {
                sweep_dust::get_swap_move_call(package_id, bcs, swap_info_arg, squid_arg)
            } else {
                assert!(swap_type == SWAP_TYPE_DEEPBOOK_V2, EInvalidSwapType);
                deepbook_v2::get_swap_move_call(package_id, bcs, swap_info_arg)
            },
        );
        i = i + 1;
    };
}
```

As a result, if `sweep` is called before `swap`, all balances of coin T1 will be moved to the `coin_bag` of the Squid router, and the source or destination address will not receive any coins. `finalize` contains a safeguard to ensure that the balance value (`balance.value()`) is greater than or equal to `self.min_out`. However, this safeguard will not be effective if `min_out` is set to zero.

## Remediation
Enforce the correct order of execution between the `swap` and `sweep` calls in `get_transaction`.

## Patch
Fixed in PR #28.

Â© 2024 Otter Audits LLC. All Rights Reserved. 9/18
