# Abort via Large Node Capacity Value

## Summary
The report mentions a potential issue with how votes are calculated in a function called "select_committee_and_calculate_votes". This issue is related to a parameter called "node_capacity" which refers to a node's ability to handle load. If a malicious node sets this parameter to a very high value, it can cause an error and abort the process. The report suggests a solution by placing a limit on the value of node_capacity and making a small change in the code. This issue has been fixed in a recent update.

## Details
## Potential Flaw in Vote Calculations

There is a potential flaw in how the vote calculations are handled in `select_committee_and_calculate_votes`, particularly with the `node_capacity` parameter, which may result in an abort. The `node_capacity` refers to the nodeâ€™s capacity in terms of how much load it can handle. If a malicious node sets `node_capacity` to an excessively large value, the capacity vote calculation will result in an extremely high `capacity_vote`.

> _sources/staking/staking_inner.move rust_

```rust
/// Selects the committee for the next epoch.
public(package) fun select_committee_and_calculate_votes(self: &mut StakingInnerV1) {
    [...]
    // Iterate over the next committee to do the following:
    // - store the next epoch public keys for the nodes
    // - calculate the votes for the next epoch parameters
    node_ids.length().do!(|idx| {
        [...]
        // Perform calculation of the votes.
        write_prices.insert(pool.write_price(), weight);
        storage_prices.insert(pool.storage_price(), weight);
        let capacity_vote = (pool.node_capacity() * (self.n_shards as u64)) / weight;
        capacity_votes.insert(capacity_vote, weight);
    });
    [...]
}
```

`capacity_vote` is calculated as the product of `node_capacity` and `n_shards`, divided by `weight`. Thus, if `node_capacity` is excessively large, the result of this multiplication will yield an overflow.

## Remediation

Ensure to place a cap on the `node_capacity` value and cast `u64` to `u128`.

## Patch

Fixed in `cc4aaaa`.
