# Bypassing Stake Threshold Check

## Summary
No summary provided.

## Details
## Vulnerability in ActiveSet::update

ActiveSet::update does not enforce a minimum stake threshold (`set.threshold_stake`), unlike `insert`. This introduces a vulnerability where a user may manipulate their stake to gain a position in the active set below the required threshold.

> _sources/staking/active_set.move rust

```rust
/// Updates the staked amount of the storage node with the given `node_id` in
/// the active set. Returns true if the node is in the set.
public(package) fun update(set: &mut ActiveSet, node_id: ID, staked_amount: u64): bool {
    let index = set.nodes.find_index!(|entry| entry.node_id == node_id);
    if (index.is_none()) {
        return false;
    };
    index.do!(|idx| {
        set.total_stake = set.total_stake + staked_amount - set.nodes[idx].staked_amount;
        set.nodes[idx].staked_amount = staked_amount;
    });
    true
}
```

## Example of Exploitation

For example, a user may stake an amount greater than `set.threshold_stake`, ensuring that their node is successfully inserted via `ActiveSet::insert`. If the active set is full, the node with the lowest stake is removed to accommodate the new entry. After successfully inserting, the user immediately calls `ActiveSet::update` to lower their stake below `set.threshold_stake`. As a result, the attacker secures a place in the active set without the required stake amount.

## Remediation

Modify `update` to check if the new `staked_amount` meets the `threshold_stake` requirement before updating the node. Also, ensure `ActiveSet` removes nodes whose staked amount falls below the required `threshold_stake`.

## Patch

Fixed in `134fee8`.
