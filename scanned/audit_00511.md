# Improper Price Deviation Calculation Formula

## Summary
The bug report is about a function called get_price_diff_ that is used to calculate the percentage difference between two prices. However, the current implementation of the function is incorrect as it uses the new price as the denominator when it should be using the old price. This leads to incorrect calculation of the percentage deviation. The bug has been fixed in a recent patch by using the correct denominator in both cases.

## Details
## Price Deviation Calculation

The `get_price_diff_` function is responsible for computing price deviation. To calculate the percentage of price deviation, the formula should be:

```
(diff(new_price, old_price) / old_price) * 100
```

The current implementation uses `new_price` as the denominator if `new_price > old_price`.

## Code Implementation

The relevant code is located in the `thala-protocol-v1/sources/oracle.move` file:

```rust
// Get the difference between two prices a and b in percentage. Result is
// rounded to nearest integer
fun get_price_diff_pct(a: FixedPoint64, b: FixedPoint64): u64 {
    if (fp64::gt(&a, &b)) {
        fp64::decode(fp64::mul(fp64::div_fp(fp64::sub_fp(a, b), a), 100))
    } else if (fixed_point64::lt(&a, &b)) {
        fp64::decode(fp64::mul(fp64::div_fp(fp64::sub_fp(b, a), b), 100))
    } else {
        0
    }
}
```

## Remediation

To properly calculate the percentage deviation, use `b` (old_price) as the denominator in both cases.

## Patch

This issue was fixed in commit `bd1e275` by using `b` as the denominator in both cases.
