# Wallet Balance Misverification

## Summary
The bug report identifies an issue with the check_wallets_for_list function in the ds_token code. This function checks the total token balance for an investor instead of the balance in each individual wallet. This means that even if a wallet has zero tokens, it will still be added to the active wallet list if the investor's total balance is non-zero. This could potentially allow an investor to create a large number of empty wallets and initiate token transfers to them with a value of zero, causing a denial-of-service scenario. However, this attack would be costly and there is no direct monetary gain. The report suggests verifying the balance of each individual wallet and moving the check_wallets_for_list function to the end of the deposit process to ensure it is consistently called and accurately updates the wallet registry after every deposit action. The issue has been resolved in a recent patch.

## Details
## ds_token::check_wallets_for_list

`ds_token::check_wallets_for_list` checks the total token balance for an investor instead of the balance in each individual wallet. This implies that even if a wallet holds zero tokens, it will still be added to the active wallet list if the investorâ€™s total balance is non-zero. This discrepancy may allow an investor to create a large number of empty wallets that are added to the wallet tracking structures (`wallet_indexes` and `wallet_list`). Thus, an investor may create numerous dead wallets (wallets with a zero token balance), initiating a token transfer to each of these wallets with a value of zero.

> _move/sources/ds_token.move rust

```rust
/// Check wallets for list.
/// This function is called after every transfer, burn, mint, and seize operation.
fun check_wallets_for_list(from: address, to: address) acquires WalletData {
    let from_balance =
        registry_service::investor_wallet_balance_total(
            registry_service::get_investor(from)
        );
    let to_balance =
        registry_service::investor_wallet_balance_total(
            registry_service::get_investor(to)
        );
    if (from_balance == 0) {
        remove_wallet_from_list(from)
    };
    if (to_balance > 0) {
        add_wallet_to_list(to)
    };
}
```

Consequently, the function will add these wallets to `wallet_list` and `wallet_indexes`. With a large number of zero-balance wallets in `wallet_list` and `wallet_indexes`, the transfer functionality for some wallets may result in a hash denial-of-service scenario. However, executing this attack is costly, and there is no direct monetary reward to benefit from. Furthermore, it is a regulated environment where all wallets have to undergo a KYC procedure.

Additionally, `check_wallets_for_list` is called after each transfer and `transfer_from` operation. This function maintains a registry of active wallets, updating it to add wallets with positive balances and remove those with zero balances. However, this process does not account for transfers processed through `primary_fungible_store::deposit` and `primary_fungible_store::withdraw` flows, implying that certain wallet balance updates bypass `check_wallets_for_list`.

## Remediation

Verify the balance of each individual wallet in `check_wallets_for_list`. Also, move `check_wallets_for_list` to the end of the deposit to ensure it is called consistently, updating the wallet registry accurately after every deposit action regardless of the transfer method.

## Patch

Resolved in `438f61f`.
