# Inconsistent Storage Of Staked Coins

## Summary
No summary provided.

## Details
## Potential Issue in Staking Method

The storing of staked SUI in two different locations by the `request_stake_coin` method may result in a potential issue. This method enables such storage based on whether the user has specified a validator or not, which may lead to a situation where a malicious user can prevent other users from withdrawing their funds immediately.

## Code Snippet

```rust
/// stake and return haSUI
public fun request_stake_coin(wrapper: &mut SuiSystemState, staking: &mut Staking, input: Coin<SUI>, validator: address, ctx: &mut TxContext): Coin<HASUI> {
    [...]
    // user does not select a validator, or selects an invalid validator, just let protocol to select a validator
    if (validator == @0x0 || !is_active_validator(validator, &active_validators)) {
        // deposit sui to vault, and wait for staking later
        vault::deposit(&mut staking.sui_vault, coin::into_balance(input));
    } else { // user selects a validator
        save_user_selected_staking(staking, input, validator);
    };
    [...]
}
```

This occurs as `request_stake_coin` stores the staked SUI in `sui_vault` in the case a user did not specify any validator, chose an inactive validator, or if the chosen validator is `0x0`. However, when an active validator is selected, the staked SUI is stored in `user_selected_validator_bals` as shown below.

## Code Snippet

```rust
fun save_user_selected_staking(staking: &mut Staking, input: Coin<SUI>, validator: address) {
    [...]
    let validator_balance = vec_map::get_mut(&mut staking.user_selected_validator_bals, &validator);
    balance::join(validator_balance, coin::into_balance(input));
}
```

Thus, this allows a user to choose an active validator while staking coins, which results in storing their staked coins in `user_selected_validator_bals`. Consequently, the user may unstake their SUI via `request_unstake_instant`, which withdraws the staked SUI stored in `sui_vault` instead of deducting from `request_unstake_instant`, where the user’s stake is stored. This may drain staked SUI from `sui_vault`, thereby preventing users with staked coins in `sui_vault` from withdrawing due to lack of funds.

---

## Haedal Audit 05 | General Findings

### Remediation

Deduct staked coins from the correct storage location based on where the user’s staked SUI is stored.
