# Potential Deposit Lockup

## Summary
The report highlights a potential vulnerability in the logic of the deposit_coin_to_reserve function. This function prioritizes repaying existing loans with the repay_coin before using it for minting liquidity provider tokens. However, the function then utilizes the minted liquidity provider tokens for collateral through reserve::add_collateral<Coin0>(lp_coin), which may not be allowed for some coins within the Aries Markets protocol. This can result in the function failing and potentially leaving the user with outstanding debt and liquidation penalties. The recommended solution is to modify the function to check if the deposit_coin is an acceptable collateral type before using it as collateral. The issue has been fixed in version 06f2587.

## Details
## Potential Vulnerability in `deposit_coin_to_reserve` Logic

There is a potential vulnerability in the logic of `deposit_coin_to_reserve`. It prioritizes repaying existing loans with the `repay_coin` before utilizing it for minting liquidity provider tokens. However, the function then utilizes the minted liquidity provider tokens (representing the remaining `deposit_coin`) for collateral through `reserve::add_collateral<Coin0>(lp_coin)`.

> _controller.moverust_
```rust
fun deposit_coin_to_reserve<Coin0>(
    repay_coin: Coin<Coin0>,
    deposit_coin: Coin<Coin0>,
) {
    let repay_remaining_coin = reserve::repay<Coin0>(repay_coin);
    coin::destroy_zero<Coin0>(repay_remaining_coin);
    let lp_coin = reserve::mint<Coin0>(deposit_coin);
    reserve::add_collateral<Coin0>(lp_coin);
}
```

The issue arises because some coins may not be allowed as collateral within the Aries Markets protocol. If the `repay_coin` is one such coin, it gets utilized for repayment first. But since the minted liquidity provider tokens represent the remaining `deposit_coin` (of the same type as `repay_coin`), adding them as collateral fails. Thus, even if the `repay_coin` amount is enough to cover the entire loan, the call will fail, because it may not be utilized as collateral, rendering the user with outstanding debt and potential liquidation penalties.

## Remediation

Modify the function to check if `deposit_coin` is an acceptable collateral type before utilizing it as collateral.

## Patch

Fixed in `06f2587`.

Â© 2024 Otter Audits LLC. All Rights Reserved. 11/16
