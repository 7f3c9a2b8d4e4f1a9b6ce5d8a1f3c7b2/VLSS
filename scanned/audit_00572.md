# Improper Convergence Checks

## Summary
No summary provided.

## Details
## Geometric Mean Calculations

In `geometric_mean_calculations.move`, the following functions are defined: `calc_swap_fixed_in`, `calc_swap_fixed_out`, `calc_withdraw_fixed_amounts`, and `calc_deposit_fixed_amounts`. The convergence between `prev_t` and `t` is checked after the while loop. However, this approach will execute correctly because the `t` value is copied into the `prev_t` variable at the end of the loop.

## Code Example

```rust
while (i_t < MAX_NEWTONS_METHOD_ITERATIONS) {
    // while loop
    // check for convergence
    temp = if (prev_t < t) {
        t - prev_t
    } else {
        prev_t - t
    };
    if (temp <= CONVERGENCE_BOUND) {
        break
    };
    prev_t = t;
    i_t = i_t + 1;
}

// check for final convergence or fail
temp = if (prev_t < t) {
    t - prev_t
} else {
    prev_t - t
};
assert!(temp <= CONVERGENCE_BOUND, ENewtonDidNotConverge);
```

## Remediation

Check the convergence between `prev_t` and `t` using `i_t`. If `temp` becomes convergent within the while loop, `i_t` will be smaller than `MAX_NEWTONS_METHOD_ITERATIONS` and may exit the while loop via a break statement.

## Aftermath Finance Audit 04 | Vulnerabilities

However, if `temp` does not converge, `i_t` will reach `MAX_NEWTONS_METHOD_ITERATIONS`, causing the while loop to finish.

## Differences in `geometric_mean_calculations.move`

```diff
// check for final convergence or fail
- temp = if (prev_t < t) {
-     t - prev_t
- } else {
-     prev_t - t
- };
- assert!(temp <= CONVERGENCE_BOUND, ENewtonDidNotConverge);
+ assert!(i_t < MAX_NEWTONS_METHOD_ITERATIONS, ENewtonDidNotConverge);
```

## Patch

Fixed in commit `8676084`.
