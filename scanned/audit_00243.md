# Prevention of Pool Closure Due to Rounding

## Summary
The code for the meme::get_amount_in function is causing a bug where the pool's maximum input and output amounts are being rounded down, potentially leading to a situation where the pool remains in the POOL_STATUS_OPEN state even though most of its tokens have been sold. This bug has been fixed in the latest patch.

## Details
## Explanation of `meme::get_amount_in` Function

The `meme::get_amount_in` function calculates the maximum input (`max_amount_in`) that may be provided to the pool to purchase tokens. This calculation rounds down the result to ensure that the input amount does not exceed the pool’s limits. 

After determining the actual input amount (`amount_in`), the `get_amount_out` function computes how many tokens the user will receive from the pool. This result is also rounded down to ensure that the user does not receive more tokens than the system allows.

## Code Example

> _ contracts/hopfun/sources/meme.move rust

```rust
fn earn_emissions(&mut self, vault: &Vault) {
    // TODO - consider negative rates
    let sy_balance = self.total_sy_balance(vault);
    for (index, emission) in vault.emissions.iter().enumerate() {
        let e = &mut self.emissions[index];
        let earned_emission = calc_share_value(e.last_seen_index, emission.final_index, sy_balance);
        e.inc_staged(earned_emission);
        e.last_seen_index = emission.last_seen_index;
    }
}
```

## Potential Issue

Because both `max_amount_in` and `amount_out` are rounded down, a situation may arise where the pool’s `max_amount_out` may never be fully extracted. This could result in the pool remaining perpetually in the `POOL_STATUS_OPEN` state even though the majority of its tokens have been sold.

## Remediation

Ensure that rounding occurs only in one step.

## Patch

Fixed in commit `0923bc9`.
