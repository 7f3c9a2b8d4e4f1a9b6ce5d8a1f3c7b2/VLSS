# Transaction Failure Due To Race Condition

## Summary
No summary provided.

## Details
## Purchase Transaction Process

When a buyer initiates a purchase transaction, the seller’s profile issues a receipt. This receipt contains crucial information, such as the master ID and the user profile associated with the transaction. Meanwhile, after issuing the receipt but before the buyer completes the transaction, the seller, who also owns the `Master<T>` object, updates its sales status. This status update changes the master object's state from `ON_SALE` to the `RETAINED` state.

```rust
> _move/sources/profile.moverust
public fun buy<T: drop>(
    seller_profile: &mut Profile,
    master: Receiving<Master<T>>,
    buyer_profile: &mut Profile,
    receipt: Receiving<Receipt>,
) {
    [...]
    // Validate the master id from the receipt and the master object
    assert!(object::id(&master) == master_id, EInvalidObject);
    // Only masters with ON_SALE status can be bought
    assert!(master.sale_status<T>() == ON_SALE, EMasterNotOnSale);
    // Update the sale status of the master object to RETAINED
    master.update_sale_status<T>(RETAINED);
    // Transfer the master to the buyer profile
    transfer::public_transfer(master, user_profile);
}
```

Consequently, when the buyer invokes `profile::buy`, the purchase transaction will fail since it expects the status to be `ON_SALE`. Consequently, the buyer is unable to acquire the `Master<T>` object even though they possess a valid receipt.

## Remediation

Implement mechanisms to ensure atomicity and consistency in the transaction process.

## Patch

Fixed in `b2d7dad` by implementing an additional `CLAIMED` status. This prevents the `Master` from being borrowed if the `Receipt` was created. The `unlist` and `list` functions also check the `CLAIMED` status.

© 2024 Otter Audits LLC. All Rights Reserved. 7/14
