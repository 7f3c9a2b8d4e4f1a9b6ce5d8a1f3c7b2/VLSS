# Improper Withdrawal Fee Calculation Formula

## Summary
No summary provided.

## Details
## Withdrawal Fee Calculation

`withdraw_mod` handles the withdrawal fee calculation. To determine the withdrawal fee amount, the intended formula should utilize the following:

```
(1 - (elapsed_time / withdrawal_fee_period)) * withdrawal_fee_max_ratio
```

This formula decreases the withdrawal fee proportionally over time. However, in the implemented formula, the `cover_ratio` is not subtracted from one when calculating the `fee_ratio` value. 

As a result, users who withdraw shortly after depositing may encounter almost zero withdrawal fees, while those who withdraw just before the withdrawal period may face maximum withdrawal fees.

## Code Implementation

In the file `thala_protocol/sources/stability_pool.move` (RUST), the current implementation is as follows:

```rust
let withdrawal_fee_amount =
    if (elapsed_time_seconds >= params.withdrawal_fee_period_seconds) 0
    else if (elapsed_time_seconds == 0) fixed_point64::decode(
        fixed_point64::mul(params.withdrawal_fee_max_ratio, amount)
    )
    else {
        let cover_ratio = fixed_point64::fraction(elapsed_time_seconds, params.withdrawal_fee_period_seconds);
        let fee_ratio = fixed_point64::mul_fp(cover_ratio, params.withdrawal_fee_max_ratio);
        fixed_point64::decode(fixed_point64::mul(fee_ratio, amount))
    };
```

## Remediation

To remediate the issue, use the correct formula for calculating `fee_ratio`:
```
fee_ratio = (1 - cover_ratio) * withdrawal_fee_max_ratio.
```

## Patch

The issue has been fixed in commit `dded61d` by implementing the correct formula.
