# Code Improvements

## Summary
No summary provided.

## Details
**Update**
Addressed in: `80f46b0`. The following issues were fixed: 4.1, 4.2, 4.3, and 4.5. The other issues remain unresolved.

**File(s) affected:**`isolated_lending/sources/isolated_lending.move`, `isolated_lending/sources/farming.move`, `lending_core/sources/farming.move`, `lending_core/sources/lending.move`

**Description:** The following code improvements have been identified:

1.   `isolated_lending/isolated_lending.move`:
    1.   Comment on `L133` (`Note that this can be overriden by emode's collateral_factor_bps`) mentions an `emode` which does not exist in this contract. 

2.   `isolated_lending/farming.move`:
    1.   `new_epoch_internal()`: Consider changing `reward_per_day` to `reward_per_second` to move the computation of `reward_per_day / SECONDS_PER_DAY` to be off-chain.
    2.   `init_alloc_point()`: The else-case in L262-L264 may be removed as it is never executed, due to the enforced assert in L244.
    3.   `update_alloc_point()`: Consider moving the emission of the event into the if-statement, to only emit if any values have been changed. Otherwise, consider removing the if-statement and asserting the `new_alloc_point` to be different from `prev_alloc_point`.
    4.   `isolated_lending::farming.move#L359`: Contrary to the functions comment, it is also callable from `withdraw_fa()`, `preview_withdraw()`, `liquidate_fa()`, `repay()`, `repay_fa()`, `preview_repay()`, `remove_collateral()`, `remove_collateral_fa()` and `preview_remove_collateral()`. 

3.   `lending_core/farming.move`:
    1.   `new_epoch_internal()`: Consider changing `reward_per_day` to `reward_per_second` to move the computation of `reward_per_day / SECONDS_PER_DAY` to be off-chain.
    2.   `init_alloc_point()`: The else-case in L262-L264 may be removed as it is never executed, due to the enforced assert in L244.
    3.   `update_alloc_point()`: Consider moving the emission of the event into the if-statement, to only emit if any values have been changed. Otherwise, consider removing the if-statement and asserting the `new_alloc_point` to be different from `prev_alloc_point`.
    4.   `lending_core::farming.move#L379`: Contrary to the functions comment, it is also callable from `clear_bad_debt()`, `clear_bad_debt_batch()`, `withdraw_fa`, `repay()`, `repay_fa()`, `liquidate_fa()`.

4.   `lending_core/lending.move`:
    1.   `MARKET_NAME_PREFIX`: Constant remains unused and may be removed.
    2.   `ERR_LENDING_MARKET_ALREADY_INITIALIZED`: Error remains unused and may be removed.
    3.   `ERR_LENDING_MARKET_INSUFFICIENT_SHARES`: Error remains unused and may be removed.
    4.   Comment on `L176` (`Counter for protocol fee. The counter is reset to 0 when the protocol withdraws the fee.`) incorrectly describes the variable `total_reserve`.
    5.   Typo on `L849`: `should not in` ->`should not be in`.
    6.   Functions `withdraw_reserve_fa()`, `withdraw_fa()` and `borrow_fa()` re-implement the code instead of calling `validate_fa_info()`. Consider replacing the code with aforementioned call to improve maintainability.
    7.   `create_market_internal()`: Consider addressing the pending todo (`dedup market by fullname or metadata`) by checking for duplicates prior to adding the market.

**Recommendation:** Consider implementing the recommended code changes.
