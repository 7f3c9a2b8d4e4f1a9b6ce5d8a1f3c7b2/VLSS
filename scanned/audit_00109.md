# [M-02] `get_cost_amount` allows unlimited free domain registrations

## Summary
The `get_cost_amount` function unintentionally allows users to register long domain names for free due to a logic error. This can lead to abuse, front-running attacks, and griefing. A proof of concept shows how this can be exploited. To mitigate this issue, the logic in the function should be updated to assign a default cost for longer names. The developers have confirmed and addressed this issue by removing the option for free usernames.

## Details
The `get_cost_amount` function unintentionally sets the price for domain names of length greater than or equal to 7 to zero. This behavior is due to the following code logic:
```

let price_per_year =
    if (len == 3) {
        module_store.config.price_per_year_3char
    } else if (len == 4) {
        module_store.config.price_per_year_4char
    } else if (len < FREE_LENGTH) { // FREE_LENGTH = 7
        module_store.config.price_per_year_default
    } else {
        0
    };
```

Here, `FREE_LENGTH` is defined as `7`. When the length of the domain name is greater than or equal to `7`, the `else` branch is executed, setting the `price_per_year` to `0`. While this behavior may be intentional to make longer domain names free, it opens the system to abuse.

### Impact

* **Abuse of free registrations:** Users can register unlimited long domain names at zero cost, leading to resource hoarding and potential abuse of the system.
* **Front-running attacks:** Malicious users could register desired long domain names before legitimate users, reducing availability.
* **Griefing:** Attackers can clog the domain name system by registering a large volume of free domains, creating disruptions for legitimate users.

The lack of cost for these registrations incentivizes malicious behavior, as attackers only incur transaction fees.

### Proof of Concept

**Exploitation Steps:**

1. A user selects a domain name of 7 or more characters.
2. The `get_cost_amount` function assigns a cost of `0` due to the `else` branch in the logic.
3. The user registers the domain name for free.

**Code Reference:**

The issue originates from the following code snippet:
```

if (len < FREE_LENGTH) { // FREE_LENGTH = 7
    module_store.config.price_per_year_default
} else {
    0
}
```

As long as `len >= 7`, the `else` branch ensures the `price_per_year` is zero, enabling free registrations for long domain names.

See code reference from the relevant GitHub repository [here](https://github.com/code-423n4/2025-01-initia-move/blob/main/usernames-module/sources/name_service.move# L590-L613).

### Recommended mitigation steps

To prevent abuse and ensure proper pricing for all domain names, update the logic in the `get_cost_amount` function as follows:
```

let price_per_year =
    if (len == 3) {
        module_store.config.price_per_year_3char
    } else if (len == 4) {
        module_store.config.price_per_year_4char
    } else if (len < FREE_LENGTH) {
        module_store.config.price_per_year_default
    } else {
        module_store.config.price_per_year_default // Assign a default cost for longer names
    };
```

**[andrew (Initia) confirmed and commented](https://code4rena.com/audits/2025-01-initia-move/submissions/F-15?commentParent=x3Duxa9gWaN):**

> We decided to remove the free username and just keep 3 prices (3 char, 4 char and 5+ char). Hereâ€™s the [commit](https://github.com/initia-labs/usernames-module/pull/2/commits/f9aa57ec67d73a84ec9f63a600bd515fb46f81cb).

---
