# [M-04] Incorrect request type in oracle currency pairs query whitelist breaks price discovery

## Summary
This report describes a bug in the `GetAllCurrencyPairs` query endpoint in the `keepers.go` file. The bug is caused by a mismatch between the expected and actual request types, which leads to an error when clients try to query the supported currency pairs. This endpoint is used for market data initialization and price oracle operations, and is part of the Skip Protocol's oracle system. The bug can affect the initialization of market data during genesis, preventing clients from querying the list of supported currency pairs. This is a medium severity bug, as it can impact the function of the protocol and cause value to be lost. The recommended mitigation step is to correct the request type in the query whitelist configuration.

## Details
In `keepers.go`, the `GetAllCurrencyPairs` query endpoint is misconfigured with an incorrect request type:

The root cause is that the request type is incorrectly set to `GetAllCurrencyPairsResponse` when it should be `GetAllCurrencyPairsRequest`. This mismatch between the expected and actual request types causes a protocol buffer deserialization error when clients attempt to query the supported currency pairs.

The `GetAllCurrencyPair`s endpoint is used during market data initialization and price oracle operations. Looking at the imports and genesis setup, we can see that this is [part of the Skip Protocol’s oracle system](https://github.com/initia-labs/minimove/blob/b36d068a7faec31a59d56472e77a9785397f9663/app/keepers/keepers.go# L83) (from `github.com/skip-mev/connect/v2/x/oracle/types`).

A specific use case that would be broken by this bug is the initialization of market data during genesis, as seen in the [`AddMarketData`](https://github.com/initia-labs/minimove/blob/b36d068a7faec31a59d56472e77a9785397f9663/app/genesis.go# L49-L109) function in `genesis.go`. The oracle genesis state is configured here, and the currency pairs are essential for setting up initial price feeds for trading pairs; configuring which currency pairs can be queried for prices and establishing the baseline for the auction module’s pricing functionality.

This would prevent any client (including the app itself) from querying the list of supported currency pairs; which is critical for validators who need to know which pairs they should be providing price data for, trading interfaces that need to display available trading pairs and the auction module which needs to verify valid currency pairs for pricing assets.

This is particularly impactful because while individual price queries (via `/connect.oracle.v2.Query/GetPrice`) would still work, the ability to discover what pairs are actually supported is completely broken; making it impossible to programmatically determine which pairs are valid without hardcoding them.

### Proof of concept

Issue is in the query whitelist configuration in [app/keepers/keepers.go](https://github.com/initia-labs/minimove/blob/b36d068a7faec31a59d56472e77a9785397f9663/app/keepers/keepers.go# L550-L553):
```

File: app/keepers/keepers.go
550: 	queryWhitelist.Stargate["/connect.oracle.v2.Query/GetAllCurrencyPairs"] = movetypes.ProtoSet{
551: 		Request:  &oracletypes.GetAllCurrencyPairsResponse{}, <-------
552: 		Response: &oracletypes.GetAllCurrencyPairsResponse{},
553: 	}
```

The genesis state initialization in `app/genesis.go` that depends on this functionality:
```

File: app/genesis.go
49: func (genState GenesisState) AddMarketData(cdc codec.JSONCodec, ac address.Codec) GenesisState {
50: 	var oracleGenState oracletypes.GenesisState
51: 	cdc.MustUnmarshalJSON(genState[oracletypes.ModuleName], &oracleGenState)
52:   // ... market data initialization depending on currency pairs
```

When clients attempt to query `/connect.oracle.v2.Query/GetAllCurrencyPairs`, the request will fail because:

1. The client sends a `GetAllCurrencyPairsRequest` message.
2. The system attempts to deserialize this into a `GetAllCurrencyPairsResponse` type.
3. The deserialization fails due to message type mismatch.

### Recommended mitigation steps

Correct the request type in the query whitelist configuration:
```

	queryWhitelist.Stargate["/connect.oracle.v2.Query/GetAllCurrencyPairs"] = movetypes.ProtoSet{
-		Request:  &oracletypes.GetAllCurrencyPairsResponse{},
+       Request:  &oracletypes.GetAllCurrencyPairsRequest{},
		Response: &oracletypes.GetAllCurrencyPairsResponse{},
	}
```

**[hoon (Initia) commented](https://code4rena.com/audits/2025-01-initia-move/submissions/F-42?commentParent=bVVFRdQ7zsR):**

> Revision [here](https://github.com/initia-labs/minimove/commit/9ceb00e4746ddabbecf7f0be7cf53bf0d46c74e7).

**[beer-1 (Initia) confirmed, but disagreed with severity and commented](https://code4rena.com/audits/2025-01-initia-move/submissions/F-42?commentParent=bVVFRdQ7zsR&commentChild=2LMohxVC3Td):**

> Good to lower the severity to low.

**[LSDan (judge) commented](https://code4rena.com/audits/2025-01-initia-move/submissions/F-42?commentParent=bVVFRdQ7zsR&commentChild=zTdXyrPJZUA):**

> @beer-1 - I view this as a a valid medium:
>
> > 2 — Med: Assets not at direct risk, but the function of the protocol or its availability could be impacted, or leak value with a hypothetical attack path with stated assumptions, but external requirements.
>
> This does present to me as an unavailable function of the protocol that is expected to work and important to the workflow of integrators. Please feel free to elaborate as to why you view it as low risk.

---
