### Title
OperatorCap Can Extract Protocol Treasury Fees - Insufficient Capability Separation

### Summary
The Volo vault system conflates operational capabilities with treasury management capabilities in the `OperatorCap`. Similar to the external report where `TreasuryCap` controlled both minting and metadata updates, `OperatorCap` can both execute vault operations AND withdraw accumulated deposit/withdraw fees. This violates the principle of least privilege, allowing operators to drain protocol revenue that should only be accessible to administrators.

### Finding Description

The external report identifies a capability separation issue where `TreasuryCap` combines distinct privileges (minting/burning vs. metadata updates). The analogous pattern exists in Volo's vault system where `OperatorCap` combines operational privileges with treasury extraction privileges.

**Root Cause in Volo:**

In the vault management module, two separate functions exist for fee retrieval:
- `retrieve_deposit_withdraw_fee` requiring `AdminCap` [1](#0-0) 
- `retrieve_deposit_withdraw_fee_operator` requiring `OperatorCap` [2](#0-1) 

Both functions call the same underlying implementation that extracts fees from the vault's treasury balance [3](#0-2) 

The `deposit_withdraw_fee_collected` balance accumulates protocol revenue from:
- Deposit fees [4](#0-3) 
- Withdraw fees [5](#0-4) 

**Exploit Path:**

1. Admin creates and distributes `OperatorCap` to operators for handling vault operations [6](#0-5) 
2. Normal users deposit/withdraw, accumulating fees in `deposit_withdraw_fee_collected`
3. Operator holding `OperatorCap` calls `retrieve_deposit_withdraw_fee_operator` with any amount up to total collected fees
4. The vault transfers the fee balance to the operator [7](#0-6) 
5. No additional authorization checks prevent this treasury extraction

**Why Current Protections Fail:**

The function only checks vault status (must be NORMAL) but does not distinguish between operational vs. treasury privileges [8](#0-7) 

The comment states "Only called by the admin" but this is not enforcedâ€”both `AdminCap` and `OperatorCap` can access it [9](#0-8) 

### Impact Explanation

**Concrete Protocol Impact:**

An operator with `OperatorCap` can drain all accumulated deposit and withdraw fees from the vault treasury. These fees represent protocol revenue intended for the admin/treasury, not operational funds. This constitutes direct fund theft from the protocol's fee collection mechanism.

The test suite confirms this behavior is functional and intentional, showing operators successfully extracting fees [10](#0-9) 

**Severity Justification:**

- Direct loss of protocol revenue
- Violates trust boundary between operations and treasury management
- No limit on extraction amount (can drain entire fee balance)
- Affects all vaults in the system

### Likelihood Explanation

**Realistic Exploit Feasibility:**

1. **Reachable by intended actors**: The function is public and callable by any `OperatorCap` holder [2](#0-1) 

2. **Feasible preconditions**: 
   - Attacker only needs to hold an `OperatorCap`
   - `OperatorCap` is designed to be distributed for operational tasks
   - Admin creates operator capabilities for delegating vault operations [6](#0-5) 

3. **Realistic threat model**:
   - Protocol likely wants to separate operational duties (execute deposits/withdrawals) from treasury management
   - If an operator's key is compromised or operator acts maliciously, they can extract fees
   - No additional safeguards prevent this treasury access

4. **Not blocked by existing checks**: The only check is vault status, not capability privilege level [8](#0-7) 

### Recommendation

**Specific Code-Level Mitigation:**

Remove the `retrieve_deposit_withdraw_fee_operator` function entirely from `volo-vault/sources/manage.move`. Treasury operations (fee extraction) should only be accessible via `AdminCap`, not `OperatorCap`.

```
// DELETE THIS FUNCTION:
public fun retrieve_deposit_withdraw_fee_operator<PrincipalCoinType>(
    _: &OperatorCap,
    vault: &mut Vault<PrincipalCoinType>,
    amount: u64,
): Balance<PrincipalCoinType>
```

This enforces clear capability separation:
- `AdminCap`: Treasury management, configuration, fee extraction
- `OperatorCap`: Operational tasks only (execute deposits/withdrawals, manage operations)

Update the underlying `retrieve_deposit_withdraw_fee` function documentation to reflect that it's admin-only and remove the package visibility if not needed by other internal modules.

### Proof of Concept

**Reproducible Exploit Steps:**

1. **Setup**: Admin creates vault and distributes `OperatorCap` to operator for handling user deposits/withdrawals
   - Vault collects deposit fees (default 10bp = 0.1%) [11](#0-10) 
   - Vault collects withdraw fees (default 10bp = 0.1%) [12](#0-11) 

2. **Normal Operation**: Users deposit 1000 SUI total
   - Deposit fee collected: 1 SUI (0.1%)
   - Fee accumulated in `deposit_withdraw_fee_collected` balance

3. **Treasury Extraction by Operator**:
   ```
   // Operator calls (confirmed working in test suite):
   vault_manage::retrieve_deposit_withdraw_fee_operator(
       &operator_cap,
       &mut vault,
       1_000_000_000  // 1 SUI in MIST
   )
   ``` [10](#0-9) 

4. **Result**: Operator receives 1 SUI from protocol fee treasury, reducing admin's expected revenue to 0

5. **Vault State**: `deposit_withdraw_fee_collected` balance is drained by operator, not admin [13](#0-12) 

**Notes:**

This vulnerability represents the same class as the external report: capability conflation where a single capability object (`OperatorCap`) grants multiple unrelated privileges (operations AND treasury access) that should be separated into distinct capabilities for better security and privilege isolation.

### Citations

**File:** volo-vault/sources/manage.move (L84-86)
```text
public fun create_operator_cap(_: &AdminCap, ctx: &mut TxContext): OperatorCap {
    vault::create_operator_cap(ctx)
}
```

**File:** volo-vault/sources/manage.move (L142-148)
```text
public fun retrieve_deposit_withdraw_fee<PrincipalCoinType>(
    _: &AdminCap,
    vault: &mut Vault<PrincipalCoinType>,
    amount: u64,
): Balance<PrincipalCoinType> {
    vault.retrieve_deposit_withdraw_fee(amount)
}
```

**File:** volo-vault/sources/manage.move (L150-156)
```text
public fun retrieve_deposit_withdraw_fee_operator<PrincipalCoinType>(
    _: &OperatorCap,
    vault: &mut Vault<PrincipalCoinType>,
    amount: u64,
): Balance<PrincipalCoinType> {
    vault.retrieve_deposit_withdraw_fee(amount)
}
```

**File:** volo-vault/sources/volo_vault.move (L30-30)
```text
const DEPOSIT_FEE_RATE: u64 = 10; // default 10bp (0.1%)
```

**File:** volo-vault/sources/volo_vault.move (L31-31)
```text
const WITHDRAW_FEE_RATE: u64 = 10; // default 10bp (0.1%)
```

**File:** volo-vault/sources/volo_vault.move (L830-836)
```text
    let deposit_fee = coin_amount * self.deposit_fee_rate / RATE_SCALING;

    // let actual_deposit_amount = coin_amount - deposit_fee;
    let mut coin_balance = coin.into_balance();
    // Split the deposit fee to the fee collected
    let deposit_fee_balance = coin_balance.split(deposit_fee as u64);
    self.deposit_withdraw_fee_collected.join(deposit_fee_balance);
```

**File:** volo-vault/sources/volo_vault.move (L1040-1042)
```text
    let fee_amount = amount_to_withdraw * self.withdraw_fee_rate / RATE_SCALING;
    let fee_balance = withdraw_balance.split(fee_amount as u64);
    self.deposit_withdraw_fee_collected.join(fee_balance);
```

**File:** volo-vault/sources/volo_vault.move (L1543-1543)
```text
// Only called by the admin
```

**File:** volo-vault/sources/volo_vault.move (L1544-1557)
```text
public(package) fun retrieve_deposit_withdraw_fee<PrincipalCoinType>(
    self: &mut Vault<PrincipalCoinType>,
    amount: u64,
): Balance<PrincipalCoinType> {
    self.check_version();
    self.assert_normal();

    emit(DepositWithdrawFeeRetrieved {
        vault_id: self.vault_id(),
        amount: amount,
    });

    self.deposit_withdraw_fee_collected.split(amount)
}
```

**File:** volo-vault/tests/operation/manage.test.move (L387-391)
```text
        let fee_retrieved = vault_manage::retrieve_deposit_withdraw_fee_operator(
            &operator_cap,
            &mut vault,
            2_000_000,
        );
```

**File:** volo-vault/tests/operation/manage.test.move (L402-403)
```text
        let deposit_fee = vault.deposit_withdraw_fee_collected();
        assert!(deposit_fee == 8_000_000);
```
