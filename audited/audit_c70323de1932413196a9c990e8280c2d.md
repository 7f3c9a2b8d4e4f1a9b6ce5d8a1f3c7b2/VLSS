# Audit Report

## Title
Incomplete Version Migration Causes Permanent Pool Lock After Package Upgrade

## Summary
The VERSION migration mechanism is fundamentally broken due to incomplete migration logic. When upgrading the VERSION constant, the `migrate_version()` function only updates the StakePool's version but fails to migrate the ValidatorPool's version, causing permanent operational DoS where all user operations fail and 100% of user funds become locked.

## Finding Description

The version control system uses a global VERSION constant that enforces strict compatibility through exact equality checks. [1](#0-0) [2](#0-1) 

Both StakePool and ValidatorPool maintain **independent** `manage: Manage` fields with separate version tracking: [3](#0-2) [4](#0-3) 

**Root Cause:** The migration function only updates StakePool's version, leaving ValidatorPool's version unchanged: [5](#0-4) 

All critical operations perform multi-layer version checks. For example, `stake()` checks the StakePool version, then calls `refresh()` [6](#0-5)  which delegates to `validator_pool.refresh()`: [7](#0-6) 

The `validator_pool.refresh()` function has its own version check that fails when the ValidatorPool version is outdated: [8](#0-7) 

**Why Protection Fails:** There is no public or package-level function in ValidatorPool to migrate its version. The ValidatorPool.manage field is not exposed through any accessor or migration function, making the pool permanently locked after VERSION upgrade.

## Impact Explanation

**Severity: CRITICAL - Complete Operational DoS**

When VERSION changes (e.g., 2â†’3):

**After calling `migrate_version()`:** Pool remains broken because ValidatorPool's version is still at the old value. All operations that call `refresh()` fail at `validator_pool.refresh()`'s version check:
- `stake()`: [9](#0-8) 
- `unstake()`: [10](#0-9) 
- `collect_fees()`: [11](#0-10) 
- `set_validator_weights()`: [12](#0-11) 
- `rebalance()`: [13](#0-12) 

**Impact Quantification:**
- 100% of user funds locked (cannot unstake)
- 100% operational downtime (cannot stake new funds)
- Admin cannot collect fees or rebalance validators
- No recovery path exists without emergency package upgrade
- Permanent loss of protocol functionality until fixed

## Likelihood Explanation

**Likelihood: CERTAIN (100%)**

This is not a potential vulnerability - it is a **guaranteed outcome** of any VERSION upgrade:

1. **Automatically Triggered:** Occurs during normal package upgrade operations when VERSION constant changes
2. **No Attacker Required:** This is a design flaw, not an attack scenario
3. **Deterministic Failure:** The version check [14](#0-13)  always fails with mathematical certainty when versions don't match
4. **Universal Impact:** Affects all existing pools immediately upon upgrade
5. **No Bypass Possible:** The strict equality check in `check_version()` cannot be circumvented

Even with AdminCap access, there is no way to fix ValidatorPool's version since no migration function exists for it.

## Recommendation

Add a migration function for ValidatorPool similar to StakePool's implementation:

```move
// In validator_pool.move
public(package) fun migrate_validator_pool_version(self: &mut ValidatorPool) {
    self.manage.migrate_version();
}
```

Then update StakePool's `migrate_version()` to also migrate the ValidatorPool:

```move
// In stake_pool.move
public fun migrate_version(self: &mut StakePool, _: &AdminCap) {
    self.manage.migrate_version();
    self.validator_pool.migrate_validator_pool_version(); // Add this line
}
```

Alternatively, make the migration function directly accessible on ValidatorPool with AdminCap authorization.

## Proof of Concept

```move
#[test]
fun test_version_migration_dos() {
    let mut scenario = test_scenario::begin(@0x1);
    
    // Setup: Create pool with VERSION=2
    create_stake_pool(scenario.ctx());
    scenario.next_tx(@0x1);
    
    let mut pool = scenario.take_shared<StakePool>();
    let admin_cap = scenario.take_from_sender<AdminCap>();
    
    // Simulate VERSION upgrade to 3 (in new package deployment)
    // Call migrate_version() which only updates StakePool.manage.version
    pool.migrate_version(&admin_cap);
    
    // Now ValidatorPool.manage.version = 2, but VERSION = 3
    // Attempt to stake - this should fail at validator_pool.refresh()
    let metadata = scenario.take_shared<Metadata<CERT>>();
    let mut system_state = scenario.take_shared<SuiSystemState>();
    let sui = coin::mint_for_testing<SUI>(1_000_000_000, scenario.ctx());
    
    // This call will fail with EIncompatibleVersion at validator_pool.refresh()
    pool.stake(&mut metadata, &mut system_state, sui, scenario.ctx());
    // Expected: Transaction aborts with error code 50001 (EIncompatibleVersion)
    
    scenario.return_shared(pool);
    scenario.return_shared(metadata);
    scenario.return_shared(system_state);
    scenario.return_to_sender(admin_cap);
    scenario.end();
}
```

### Citations

**File:** liquid_staking/sources/manage.move (L11-11)
```text
    const VERSION: u64 = 2;
```

**File:** liquid_staking/sources/manage.move (L21-23)
```text
    public fun check_version(self: &Manage) {
        assert!(self.version == VERSION, EIncompatibleVersion)
    }
```

**File:** liquid_staking/sources/stake_pool.move (L51-51)
```text
        manage: Manage,
```

**File:** liquid_staking/sources/stake_pool.move (L226-229)
```text
        self.manage.check_version();
        self.manage.check_not_paused();

        self.refresh(metadata,system_state, ctx);
```

**File:** liquid_staking/sources/stake_pool.move (L289-289)
```text
        self.refresh(metadata, system_state, ctx);
```

**File:** liquid_staking/sources/stake_pool.move (L342-344)
```text
    public fun migrate_version(self: &mut StakePool, _: &AdminCap) {
        self.manage.migrate_version();
    }
```

**File:** liquid_staking/sources/stake_pool.move (L367-367)
```text
        self.refresh(metadata, system_state, ctx);
```

**File:** liquid_staking/sources/stake_pool.move (L461-461)
```text
        self.refresh(metadata, system_state, ctx);
```

**File:** liquid_staking/sources/stake_pool.move (L497-497)
```text
        let is_epoch_rolled_over = self.refresh(metadata, system_state, ctx);
```

**File:** liquid_staking/sources/stake_pool.move (L514-514)
```text
        if (self.validator_pool.refresh(system_state, ctx)) { // epoch rolled over
```

**File:** liquid_staking/sources/validator_pool.move (L50-50)
```text
        manage: Manage,
```

**File:** liquid_staking/sources/validator_pool.move (L180-180)
```text
        self.manage.check_version();
```
