### Title
Build-Time Supply Chain Attack via Unpinned Git Dependencies

### Summary
Volo's dependency management uses floating git branch references (`main`, `mainnet`) instead of pinned commit SHAs for 14+ critical dependencies including Pyth oracle, Switchboard, lending_core, suilend, and mmt_v3. This directly mirrors the external report's npm dependency vulnerability, creating a supply chain attack vector where compromised or malicious upstream code could be injected during build/deployment, potentially compromising fund custody, oracle pricing, and core protocol logic.

### Finding Description

The external vulnerability involves using flexible version ranges (`^x.x.x`) in package dependencies, allowing unverified code updates. Volo exhibits the same vulnerability class through unpinned git dependencies in its Move package configuration.

**Root Cause in Move.toml:**

Multiple critical dependencies use branch names instead of commit SHAs: [1](#0-0) [2](#0-1) [3](#0-2) [4](#0-3) [5](#0-4) 

**Critical Finding in Move.lock:**

Even the lock file (which should freeze dependencies) contains branch references instead of commit SHAs for 14+ dependencies: [6](#0-5) [7](#0-6) [8](#0-7) [9](#0-8) [10](#0-9) [11](#0-10) [12](#0-11) [13](#0-12) 

**Exploit Path:**

1. Attacker compromises or gains commit access to upstream repositories (Sui-Volo org repos, Pyth, SupraOracle, or solendprotocol repos)
2. Malicious code is pushed to `main` or `mainnet` branches
3. Volo performs a build/deployment during the window when malicious code exists
4. Build system fetches latest branch state (not pinned commit), including malicious code
5. Malicious code gets compiled into deployed smart contracts
6. Malicious code executes with full protocol privileges, potentially manipulating:
   - Oracle price feeds (Pyth, Switchboard, SupraOracle modules)
   - Lending logic (lending_core, suilend modules)
   - Asset valuation (mmt_v3, oracle modules)
   - Vault operations (adaptors)

**Why Current Protections Fail:**

- No commit SHA pinning in Move.lock despite it being a lock file
- No cryptographic integrity verification (checksums, signatures) for dependencies
- No runtime version validation for external protocol dependencies in adaptors: [14](#0-13) [15](#0-14) [16](#0-15) 

### Impact Explanation

**High Severity - Fund Theft and Protocol Compromise:**

1. **Oracle Manipulation**: Compromised Pyth, Switchboard, or SupraOracle dependencies could inject false price data, enabling:
   - Incorrect vault share valuations during deposits/withdrawals
   - Bypassing slippage checks in Cetus adaptor
   - Manipulating loss_tolerance calculations

2. **Lending Logic Corruption**: Malicious lending_core or suilend code could:
   - Steal deposited funds
   - Bypass collateralization checks
   - Manipulate interest calculations
   - Drain vault assets through fake positions

3. **Asset Custody Failure**: Compromised adaptor dependencies (mmt_v3, momentum) could:
   - Redirect borrowed DeFi assets to attacker addresses
   - Report false position values to vault
   - Prevent asset returns, locking vault in operation state

4. **Authorization Bypass**: Malicious code in core modules could bypass operator freezes, pause mechanisms, or cap validations

### Likelihood Explanation

**Medium Likelihood - Realistic Attack Vector:**

1. **Multiple Attack Surfaces**: 14+ dependencies using floating references provides numerous compromise vectors
2. **Upstream Repository Access**: 
   - Sui-Volo org repositories use `rev = "main"` extensively - requires compromising Volo's own repos
   - External repos (Pyth, SupraOracle, solendprotocol) - broader attack surface
3. **Timing Window**: Attacker needs malicious code present during build, but automated deployments or scheduled builds increase exposure
4. **No Detection Mechanisms**: Absence of integrity checks means malicious code would not be detected during build
5. **Real-World Precedent**: event-stream npm attack, SolarWinds supply chain compromise demonstrate feasibility

**Not Blocked By:**
- No commit SHA verification
- No cryptographic signing of dependencies
- No build reproducibility guarantees
- No runtime version checks in adaptors

### Recommendation

**Immediate Actions:**

1. **Pin All Dependencies to Commit SHAs in Move.toml:**
   ```toml
   [dependencies.Pyth]
   git = "https://github.com/solendprotocol/pyth-crosschain.git"
   rev = "a1b2c3d4e5f6..."  # Replace branch with commit SHA
   subdir = "target_chains/sui/contracts"
   ```

2. **Verify and Update Move.lock**: Ensure lock file contains commit SHAs, not branch names

3. **Implement Dependency Integrity Verification**:
   - Add cryptographic checksums for critical dependencies
   - Validate checksums during build process
   - Use git submodules with pinned commits for critical dependencies

4. **Add Runtime Version Validation in Adaptors**:
   - Implement version checks similar to internal modules: [17](#0-16) 
   
   - Add expected package address constants for external protocols
   - Validate Storage, LendingMarket, CetusPool objects come from approved package addresses

5. **Establish Secure Build Pipeline**:
   - Use deterministic builds with dependency caching
   - Implement multi-signature approval for dependency updates
   - Audit dependency changes before deployment

### Proof of Concept

**Scenario: Pyth Oracle Compromise Leading to Vault Drain**

1. **Attacker Action**: Compromises solendprotocol/pyth-crosschain repository, pushes malicious code to `mainnet` branch that always returns artificially low prices

2. **Build Occurs**: Volo rebuilds contracts, fetches latest `mainnet` branch: [6](#0-5) 

3. **Deployment**: Malicious Pyth contract deployed as part of oracle dependency: [18](#0-17) 

4. **Exploitation**: 
   - Vault calculates artificially low total_usd_value due to manipulated oracle prices
   - Attacker deposits principal coins when prices are manipulated low
   - Receives excessive shares due to incorrect valuation
   - Prices return to normal (or attacker fixes repo)
   - Attacker withdraws with inflated share value, draining vault

5. **No Detection**: No runtime validation prevents using compromised Pyth price feeds: [19](#0-18) 

**Alternative Scenario: Switchboard Compromise**
1. Attacker compromises Sui-Volo/volo-smart-contracts `main` branch
2. Injects backdoor in Switchboard oracle adaptor dependency
3. Build fetches compromised code: [8](#0-7) 
4. Deployed contracts contain backdoor allowing oracle price manipulation
5. Attacker exploits backdoor to manipulate vault valuations and drain funds

### Citations

**File:** volo-vault/Move.toml (L7-11)
```text
[dependencies.Pyth]
git      = "https://github.com/solendprotocol/pyth-crosschain.git"
rev      = "mainnet"
subdir   = "target_chains/sui/contracts"
override = true
```

**File:** volo-vault/Move.toml (L51-54)
```text
[dependencies.lending_core]
git = "https://github.com/Sui-Volo/volo-smart-contracts.git"
subdir = "volo-vault/local_dependencies/protocol/lending_core"
rev = "main"
```

**File:** volo-vault/Move.toml (L56-62)
```text
[dependencies.Switchboard]
# git = "https://github.com/Sui-Volo/vault-dependencies"
# rev = "main"
# subdir = "on_demand"
git = "https://github.com/Sui-Volo/volo-smart-contracts.git"
subdir = "volo-vault/local_dependencies/switchboard_sui/on_demand"
rev = "main"
```

**File:** volo-vault/Move.toml (L65-71)
```text
[dependencies.suilend]
# git = "https://github.com/Sui-Volo/vault-dependencies"
# rev = "main"
# subdir = "suilend_d/suilend"
git = "https://github.com/Sui-Volo/volo-smart-contracts.git"
subdir = "volo-vault/local_dependencies/suilend_d/suilend"
rev = "main"
```

**File:** volo-vault/Move.toml (L80-86)
```text
[dependencies.mmt_v3]
# git = "https://github.com/Sui-Volo/vault-dependencies"
# rev = "main"
# subdir = "mmt_v3"
git = "https://github.com/Sui-Volo/volo-smart-contracts.git"
subdir = "volo-vault/local_dependencies/mmt_v3"
rev = "main"
```

**File:** volo-vault/Move.lock (L67-73)
```text
id = "Pyth"
source = { git = "https://github.com/solendprotocol/pyth-crosschain.git", rev = "mainnet", subdir = "target_chains/sui/contracts" }

dependencies = [
  { id = "Sui", name = "Sui" },
  { id = "Wormhole", name = "Wormhole" },
]
```

**File:** volo-vault/Move.lock (L93-99)
```text
id = "SupraOracle"
source = { git = "https://github.com/naviprotocol/supra-oracle.git", rev = "main", subdir = "supra_holder" }

dependencies = [
  { id = "Sui", name = "Sui" },
  { id = "supra_validator", name = "supra_validator" },
]
```

**File:** volo-vault/Move.lock (L102-107)
```text
id = "Switchboard"
source = { git = "https://github.com/Sui-Volo/volo-smart-contracts.git", rev = "main", subdir = "volo-vault/local_dependencies/switchboard_sui/on_demand" }

dependencies = [
  { id = "Sui", name = "Sui" },
]
```

**File:** volo-vault/Move.lock (L118-126)
```text
id = "lending_core"
source = { git = "https://github.com/Sui-Volo/volo-smart-contracts.git", rev = "main", subdir = "volo-vault/local_dependencies/protocol/lending_core" }

dependencies = [
  { id = "Sui", name = "Sui" },
  { id = "math", name = "math" },
  { id = "oracle", name = "oracle" },
  { id = "utils", name = "utils" },
]
```

**File:** volo-vault/Move.lock (L140-145)
```text
id = "math"
source = { git = "https://github.com/Sui-Volo/volo-smart-contracts.git", rev = "main", subdir = "volo-vault/local_dependencies/protocol/math" }

dependencies = [
  { id = "Sui", name = "Sui" },
]
```

**File:** volo-vault/Move.lock (L148-153)
```text
id = "mmt_v3"
source = { git = "https://github.com/Sui-Volo/volo-smart-contracts.git", rev = "main", subdir = "volo-vault/local_dependencies/mmt_v3" }

dependencies = [
  { id = "Sui", name = "Sui" },
]
```

**File:** volo-vault/Move.lock (L156-163)
```text
id = "oracle"
source = { git = "https://github.com/Sui-Volo/volo-smart-contracts.git", rev = "main", subdir = "volo-vault/local_dependencies/protocol/oracle" }

dependencies = [
  { id = "Pyth", name = "Pyth" },
  { id = "Sui", name = "Sui" },
  { id = "SupraOracle", name = "SupraOracle" },
]
```

**File:** volo-vault/Move.lock (L174-185)
```text
id = "suilend"
source = { git = "https://github.com/Sui-Volo/volo-smart-contracts.git", rev = "main", subdir = "volo-vault/local_dependencies/suilend_d/suilend" }

dependencies = [
  { id = "Bridge", name = "Bridge" },
  { id = "MoveStdlib", name = "MoveStdlib" },
  { id = "Pyth", name = "Pyth" },
  { id = "Sui", name = "Sui" },
  { id = "SuiSystem", name = "SuiSystem" },
  { id = "liquid_staking", name = "liquid_staking" },
  { id = "sprungsui", name = "sprungsui" },
]
```

**File:** volo-vault/sources/adaptors/navi_adaptor.move (L13-29)
```text
public fun update_navi_position_value<PrincipalCoinType>(
    vault: &mut Vault<PrincipalCoinType>,
    config: &OracleConfig,
    clock: &Clock,
    asset_type: String,
    storage: &mut Storage,
) {
    let account_cap = vault.get_defi_asset<PrincipalCoinType, NaviAccountCap>(asset_type);
    let usd_value = calculate_navi_position_value(
        account_cap.account_owner(),
        storage,
        config,
        clock,
    );

    vault.finish_update_asset_value(asset_type, usd_value, clock.timestamp_ms());
}
```

**File:** volo-vault/sources/adaptors/suilend_adaptor.move (L23-40)
```text
public fun update_suilend_position_value<PrincipalCoinType, ObligationType>(
    vault: &mut Vault<PrincipalCoinType>,
    lending_market: &mut LendingMarket<ObligationType>,
    clock: &Clock,
    asset_type: String,
) {
    let obligation_cap = vault.get_defi_asset<
        PrincipalCoinType,
        SuilendObligationOwnerCap<ObligationType>,
    >(
        asset_type,
    );

    suilend_compound_interest(obligation_cap, lending_market, clock);
    let usd_value = parse_suilend_obligation(obligation_cap, lending_market, clock);

    vault.finish_update_asset_value(asset_type, usd_value, clock.timestamp_ms());
}
```

**File:** volo-vault/sources/adaptors/cetus_adaptor.move (L19-30)
```text
public fun update_cetus_position_value<PrincipalCoinType, CoinA, CoinB>(
    vault: &mut Vault<PrincipalCoinType>,
    config: &OracleConfig,
    clock: &Clock,
    asset_type: String,
    pool: &mut CetusPool<CoinA, CoinB>,
) {
    let cetus_position = vault.get_defi_asset<PrincipalCoinType, CetusPosition>(asset_type);
    let usd_value = calculate_cetus_position_value(pool, cetus_position, config, clock);

    vault.finish_update_asset_value(asset_type, usd_value, clock.timestamp_ms());
}
```

**File:** volo-vault/sources/adaptors/cetus_adaptor.move (L50-52)
```text
    let price_a = vault_oracle::get_asset_price(config, clock, type_name_a);
    let price_b = vault_oracle::get_asset_price(config, clock, type_name_b);
    let relative_price_from_oracle = price_a * DECIMAL / price_b;
```

**File:** volo-vault/local_dependencies/protocol/oracle/sources/config.move (L183-185)
```text
    public fun version_verification(cfg: &OracleConfig) {
        version::pre_check_version(cfg.version)
    }
```

**File:** volo-vault/local_dependencies/protocol/oracle/sources/oracle_pro.move (L55-55)
```text
        config::version_verification(oracle_config);
```
